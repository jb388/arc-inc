---
title: "Archived Soil Incubations Project"
author: "J. Beem-Miller"
date: "30 Apr 2020"
output:
  html_notebook:
    toc: yes
    toc_depth: 2
    css: custom.css
  pdf_document:
    latex_engine: xelatex
    css: custom.css
header_includes:
  - \usepackage[utf8]{inputenc}
  - \usepackage{float}
---
```{r global_options, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = 'center', dev = 'cairo_pdf')
```

```{r setup, include = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(SoilR)
library(corrplot)
library(openxlsx)
library(ISRaD)
```
## Notes
* This workbook is intended to load and prepare the key data for analysis for the archive incubation project.
* in general, this is an updated version of script "./src/arc_inc_master.R"
* all code chunk options are set to "echo = FALSE"; see raw .Rmd file for data wrangling code.

# Introduction
The laboratory soil incubation is a commonly used technique for understanding soil carbon dynamics. Soil carbon is a heterogeneous mixture of organic matter, some of which persists in the soil for months or years, while some persists for centuries or millenia. The persistence of soil carbon can be understood through the concept of different "pools" of carbon that are defined by the mechanism by which they persist in the soil and are characterized by distinct age distributions. 

Natural abundance radiocarbon provides information about carbon dynamics on the scale of centuries to millenia, while insight into decadal scale dynamics can be gained from tracing the pulse of radiocarbon introduced into the biosphere from nuclear weapons testing ("bomb-C") in the mid-20^th^ century. The bomb-C pulse peaked in the atmosphere in the 1950s (Fig. 1), but due to differential rates of abiotic incorporation and biological processing, the peak is lagged in time and dampened in soils. The relative enrichment in bomb-C in different pools of soil carbon is a useful tool for inferring the relative rate at which carbon enters and leaves the pool, and for a homogenous pool it is functionally equivalent to the intrinsic decomposition rate.

Extracting and measuring the radiocarbon content of specific soil carbon pools is hampered by spatial and temporal heterogeneity of the mechanisms that lead to soil carbon persistence, such as physical occlusion in aggregates, association with minerals, or thermodynamics. Defining soil carbon pools empirically with techniques such as density, size, or resistance to chemical attack can be useful, but these methods also introduce artifacts and likely result in mixtures of pools with different age distributions. In contrast, although they also introduce artifacts due to disturbance and potential alteration of the microbial community, laboratory soil incubations make use of the same fractionation agent as is found *in situ*: the microbial community. Measuring the radiocarbon signal of CO~2~ ($\Delta$^14^C-CO~2~) released in laboratory incubations of bulk soils is a powerful tool for understanding the relative processing rate of carbon in soil (or transit time) as it provides an integrated measure of the weighted contribution to the release flux from pools of soil carbon with distinct processing rates. 

Interpreting $\Delta$^14^C-CO~2~ from laboratory soil incubations requires the use of a model. However, parameterizing these models is challenging, both due to the uncertainty of the persistence mechanisms themselves as well as a lack of observational constraints. Radiocarbon observations at a single point in time are very useful, but due to the curvature of the bomb-C peak there are two points in time with the same atmospheric radiocarbon value which leads to multiple model solutions. Adding observations of $\Delta$^14^C-CO~2~ at more than one point in time can greatly reduce model uncertainty by adding additioanl constraints.

Soil archives have already proven to be a valuable source of data for constraining soil carbon models by providing time series of the change in soil carbon ^14^C content. The promise of improving models further by obtaining ^14^C-CO~2~ measurements from archived soils is tantalizing, but first the possible effects of air-drying and rewetting, as well as the effect of the duration of storage, must be quantified.

Air-drying and rewetting of soils stimulates the release of CO~2~...[expand] 

We designed an experiment to assess these effects, preliminary results of which are presented in the following report.

# Hypotheses and conceptual understanding
If the null hypothesis is disproved, i.e. air-drying and rewetting (air-dry) or air-drying, rewetting, and storage (air-dry + storage) have a significant effect on $\Delta$^14^C-CO~2~ relative to control samples, there are two possible outcomes: enrichment of the respiration flux or depletion. 

In a simple two-pool soil carbon model, the treatment effect can be conceptualized as a relative change in the contribution of "slower" or "faster" cycling carbon to the respiration flux observed in control samples.

Trajectories of the change in $\Delta$^14^C over time for "slow" and "fast" soil carbon pools are shown below (Fig. 1) in relationship to the $\Delta$^14^C of the atmosphere and respired CO~2~ for a theoretical model system.

```{r conceptual-model-calcs, include = FALSE}
# initial parameter set
Datm <- rbind(graven, future14C)
Datm <- Datm[Datm$Date > 1900, c("Date", "NHc14")]
yrs <- Datm$Date

# helper fxs
lambda <- (1/8267)

k <- function(Fm) {
  (Fm*lambda)/(1-Fm)
}
fm <- function(k){
  k/(k+lambda)
}
fm_14c <- function(fm, date) {
  (fm*exp(lambda*(1950 - date)) - 1)*1000
}

# forests
f.c <- 38.96104 # forest C pool, total (mean Hainich forest C  = 24 g kg^-1); nb @ ss = sum(-1*solve(A)%*%c(f.in*f.gam, f.in*(1-f.gam)))
f.in <- 1 # inputs (12.5=mean equilibrium C flux, annual extrapolation, gC yr-1, 2011 incubation data); try much less...
f.frc <- .1 # C-stock partitioning coefficient (from Schrumpf 2013, Hainich 0-5, free light)
f.Cfast <- f.frc*f.c
f.Cslow <- f.c-f.Cfast
f.kfast <- 1/6 # unknown
f.kslow <- 1/100 # unknown
f.fast.fm <- fm(f.kfast)
f.slow.fm <- fm(f.kslow)
f.F0_Delta14C <- fm_14c(c(f.fast.fm, f.slow.fm), date = c(1900, 1900))
f.gam <- (f.c*f.Cfast*f.kfast)/(f.c*f.Cfast*f.kfast+f.c*f.Cslow*f.kslow) # input partitioning coefficient (proportion to fast pool, function of ks)
  
# # grasslands
# g.c <- 42 # C pool, total (mean Hainich grassland C g kg^-1)
# g.in <- 63.4 # inputs (mean equilibrium C flux, annual extrapolation, 2011 incubation data)
# g.frc <- .3 # C-stock partitioning coefficient (from Schrumpf 2013, average of Lacqueville, Easter Bush, Bugac, 0-5, free light)
# g.Cfast <- g.frc*g.c
# g.Cslow <- g.c-g.Cfast
# g.kfast <- 1/10 # unknown
# g.kslow <- 1/100 # unknown
# g.fast.fm <- fm(g.kfast)
# g.slow.fm <- fm(g.kslow)
# g.F0_Delta14C <- fm_14c(c(g.fast.fm, g.slow.fm), date = c(1900, 1900))
# g.gam <- (g.c*g.Cfast*g.kfast)/(g.c*g.Cfast*g.kfast+g.c*g.Cslow*g.kslow) # input partitioning coefficient (proportion to fast pool, function of ks)

# 2pool parallel model, forests
f.2p <- TwopParallelModel14(t = yrs,
                            ks = c(f.kfast, f.kslow),
                            C0 = c(f.Cfast, f.Cslow),
                            F0_Delta14C = f.F0_Delta14C,
                            In = f.in,
                            gam = f.gam,
                            inputFc = Datm)

f.2p.C14 <- getF14(f.2p)
f.2p.HR <- getF14R(f.2p)
f.2p.Ctot <- getC(f.2p)

# solve for steady-state C stocks
A <- -1*diag(c(f.kfast, f.kslow))
sum(-1*solve(A)%*%c(f.in*f.gam, f.in*(1-f.gam)))

f.2p.C14.df <- data.frame(
  years = rep(Datm$Date, 4),
  d14C = c(f.2p.C14[,1], f.2p.C14[,2], f.2p.HR, Datm$NHc14),
  pool = rep(c("fast", "slow", "respiration", "atm"), each = nrow(f.2p.C14))
  )

# # Plot C stocks to confirm flat
# plot(yrs, xlim = c(1900,2022), ylim = c(0,60))
# lines(yrs, f.2p.Ctot[, 1], col = 2)
# lines(yrs, f.2p.Ctot[, 2], col = 4)

# calculate resp flux points at 1991 and 2019 and put in data frame
obs.pts <- data.frame(pool = rep("respiration", 6),
                      years = rep(c(1991,2019),3),
                      d14c = c(mean(f.2p.C14.df[f.2p.C14.df$years > 1990 & f.2p.C14.df$years < 1992 & f.2p.C14.df$pool == "respiration", "d14C"]),
                               mean(f.2p.C14.df[f.2p.C14.df$years > 2018 & f.2p.C14.df$years < 2020 & f.2p.C14.df$pool == "respiration", "d14C"]),
                               150, 60,
                               190, 30),
                      Observation = rep(c("control",
                                          "increased slow pool contribution",
                                          "increased fast pool contribution"),
                                        each = 2))
obs.pts.r <- obs.pts[obs.pts$Observation == "control", ]
```

```{r conceptual-model-fig1}
ggplot(f.2p.C14.df, aes(years, d14C, color = pool)) +
  geom_path() +
  scale_color_manual(
    name = "Model pool",
    values = c("atm" = 8,
               "fast" = "#D81B60", 
               "respiration" = "#FFC107", 
               "slow" = "#1E88E5"),
    labels = c("atm" = "atmosphere",
               "fast" = "fast",
               "slow" = "slow")) +
  scale_x_continuous(limits = c(1950, 2022)) +
  xlab("Year") +
  ylab(expression(''*Delta*''^14*'C (â€°)')) +
  theme_bw() +
  theme(panel.grid = element_blank())
```

>**Fig `r {(fig.n <- 1)}`a. Modeled trajectories of $\Delta$^14^C over time in soil carbon pools (fast, slow, respiration flux) in relationship to observed atmospheric $\Delta$^14^C**

>*Caption:* Modeled curves derived from a conceptual two-pool parallel model system in which inputs are partitioned between faster and more slowly cycling pools without any tranfers between the pools. Carbon stocks and pool sizes are based on density fraction data for the Hainich Forest (Schrumpf et al. 2013); decomposition rates are chosen to be realistic but are arbitrary. Atmospheric $\Delta$^14^C data up to the year 2015 are from Graven et al. (2017), while data points beyond 2015 use the extrapolation method from Sierra (2018). All atmospheric data is for the northern hemisphere (zone 2).

The simplest two-pool model is a parallel system: one in which carbon entering the soil is partitioned between the two pools without any transfers from one pool to the other. However, even in this simple system, the same treatment effect can result in either enrichment or depletion depending on the year the sample was collected. The direction of change will be dependent on system dynamics, specifically the intrinsic decomposition rates of the slow and fast pools, while in more complicated sytems the amount of mixing between the pools will play a role as well. Potential treatment effects for the same parallel two-pool model system shown in Fig. 1 are shown below at two points in time (Fig. 2).

```{r conceptual-model-fig1b}
# zoom (w/ atm, to 2022)
f.2p.C14.df %>% 
  filter(years > 1987) %>%
  filter(pool != "atm") %>%
  ggplot(., aes(years, d14C)) +
  geom_path(aes(color = pool)) +
  geom_point(data = obs.pts, aes(years, d14c, shape = Observation), color = "#FFC107", stroke = 1, size = 3) +
  scale_color_manual(
    name = "Model pool",
    values = c("atm" = 8,
               "fast" = "#D81B60", 
               "respiration" = "#FFC107", 
               "slow" = "#1E88E5"),
    labels = c("atm" = "atmosphere",
               "fast" = "fast",
               "slow" = "slow")) +
  scale_shape_manual(
    name = "Observed respiration",
    values = c("control" = 16,
               "increased slow pool contribution" = 0,
               "increased fast pool contribution" = 1)) +
  scale_y_continuous(limits = c(0, 265)) +
  xlab("Year") +
  ylab(expression(''*Delta*''^14*'C (â€°)')) +
  theme_bw() +
  theme(panel.grid = element_blank())
```

>**Fig `r {(fig.n)}`b. Potential shifts in $\Delta$^14^C of respired CO~2~ in response to air-drying and rewetting, or air-drying and rewetting + storage**

>*Caption:* Blue and magenta lines show modeled trajectories of $\Delta$^14^C in fast and slow cycling soil carbon pools (same model as Fig 1), and $\Delta$^14^C of respired CO~2~ is shown in yellow. Solid circles show hypothetical observations of ^14^C or respired CO~2~ from control incubations, while the open symbols represent two possible scenarios in which ^14^C-CO~2~ shifts due to increased contribution from the fast pool (open circles), or shifts due to increassed contribution from the slow pool (open squares). Due to the crossing of the blue and magenta lines in 2009, increased contribution of the slow pool to respiration following treatment leads to relative depletion of ^14^C-CO~2~ in 1991, but relative enrichment of ^14^C-CO~2~ in 2019, while the opposite is observed for increased fast pool contribution.

In the above plot (Fig. 2), increased contribution from the slow pool leads to depletion in $\Delta$^14^C of respiration relative to the control observation in 1991 but relative enrichment in 2019.

# Methods and materials

*Radiocarbon corrections*

Although differences were small, radiocarbon data for archived samples were first corrected for decay since the year of collection before assessing treatment effects.

Decay correction formula:
$$1000 \cdot \left( (FM \cdot e^{\frac{-year_{sampled} + 1950}{8267}}) - 1 \right)$$

where FM is the fraction modern, and 8267 is the inverse of the product of the natural log of two and the true half life of ^14^C (5730 y).

```{r 14C helper fxs}
# 5. Create helper functions
# decay correction function  
decay.corr.fx <- function(year_sampled, fraction_modern) {
  ifelse(is.na(fraction_modern), NA, 1000*((fraction_modern*exp((-year_sampled + 1950)/8267))-1))
}

# d14C to fraction modern function
d14c.fm.fx <- function(year_sampled, d14c) {
  ((d14c / 1000) + 1) / exp(0.00012097 * (1950 - year_sampled))
  }

# define helper function for stripping out "NA" and non-Exploratories data
extra.clean.fx <- function(df) {
  df <- df[which(grepl("HEG", df$Probe) |
                   grepl("HEW", df$Probe) |
                   grepl("SEG", df$Probe) |
                   grepl("SEW", df$Probe)), ]
  if(length(grep("Experiment", names(df))) > 0) {
     df <- df[which(df$Experiment != "tme"), ] 
  }
  ix <- which(is.na(df$F14C) & is.na(df$`âˆ†14C.(â€°)`))
  if(length(ix) > 1) {
    df <- df[-ix, ]
  }
  return(df)
}

# extract storage duration data separately
tme.14c.fx <- function(df) {
  df$SampleName <- df$Probe
  df$Period <- "inc"
  if(length(grep("Experiment", names(df))) > 0) {
     df <- df[which(df$Experiment == "tme"), ] 
  }
  return(df)
}
```


```{r read wide ts data}
# 1. Load flux data from air-dry + storage (experiment 1) and storage duration (experiment 3) control samples, and convert from "wide" to "long" format so as to match other data. 
# Read air-dry + storage respiration control data
archive.ctl.ts.wide <- read.csv("../data/derived/arc-storage-t1-flux/arc-inc_xplr_arc-storage-t1-flux_2020-07-03.csv")

# Convert time data from wide to long
archive.ctl.ts.d <- select(archive.ctl.ts.wide, starts_with("inc_time_d")) %>%
  pivot_longer(everything(),
               names_to = "timepoint_cmtv",
               names_prefix = "inc_time_d_",
               values_to = "time_d")
# sort by timepoint_cmtv
archive.ctl.ts.d <- data.frame(archive.ctl.ts.d[order(archive.ctl.ts.d$timepoint_cmtv),])

# Convert mgCO2 data from wide to long
archive.ctl.ts.co2 <- select(archive.ctl.ts.wide, starts_with("inc_mgCO2_jar_")) %>%
  pivot_longer(everything(),
               names_to = "timepoint_cmtv",
               names_prefix = "inc_mgCO2_jar_",
               values_to = "mgCO2_jar")
# sort by timepoint_cmtv
archive.ctl.ts.co2 <- archive.ctl.ts.co2[order(archive.ctl.ts.co2$timepoint_cmtv),]

# assemble in long dataframe 
archive.ctl.ts <- data.frame(ID = rep(unique(archive.ctl.ts.wide$ID), 4),
                             Period = "inc",
                             timepoint_cmtv = rep(seq(from = 2, 
                                                      to = 5), 
                                                  each = length(archive.ctl.ts.wide$ID)),
                             time_d = archive.ctl.ts.d$time_d,
                             mgCO2_jar = archive.ctl.ts.co2$mgCO2_jar)

# add preincubation data
archive.ctl.ts.pre <- archive.ctl.ts.wide[1:length(unique(archive.ctl.ts.wide$ID)),
                                          c("ID", "preinc_time_d", "preinc_mgCO2_jar")]
archive.ctl.ts.pre <- rename(archive.ctl.ts.pre, time_d = preinc_time_d, mgCO2_jar = preinc_mgCO2_jar)
archive.ctl.ts.pre$timepoint_cmtv <- 1
archive.ctl.ts.pre$Period <- "pre"
archive.ctl.ts.pre$time_d_cmtv <- archive.ctl.ts.pre$time_d
  
# Calculate time_d_cmtv
archive.ctl.ts <- bind_rows(
  lapply(
    split(archive.ctl.ts, archive.ctl.ts$timepoint_cmtv),
    function(x) {
      x$time_d_cmtv <- x$time_d + 
        archive.ctl.ts.pre[match(x$ID, archive.ctl.ts.pre$ID), "time_d"]
      return(x)
    }
    )
  )

# rbind preinc and inc data
archive.ctl.ts <- rbind(archive.ctl.ts.pre, archive.ctl.ts)

# add SampleName column and restore Experiment column
archive.ctl.ts$SampleName <- archive.ctl.ts$ID
archive.ctl.ts$Experiment <- archive.ctl.ts.wide[match(archive.ctl.ts$ID, archive.ctl.ts.wide$ID), "Experiment"]

# remove intermediate files
rm(archive.ctl.ts.d, archive.ctl.ts.co2, archive.ctl.ts.pre)
```

```{r read-long-ts-data}
# 2. Load flux data from air-dry + storage samples and from air-dry experiment (ctl & treatment), C & N data for all the Exploratories samples (measured in 2011), and soil mass and moisture data for all experiments.
# Read Xplr C and N data
xplr.cn <- read.csv("../data/external/exploratories_ischoening_soilcn_2011/170407_CN_concentrations_Exploratories_EP_Plots_2011.csv")

# Read Xplr 14C data for control samples ("tme" and "arc" Experiments)
xplr.ctl.iso <- read.xlsx("../data/external/exploratories_ischoening_14c-co2_2011/170228_14C_Respiration.xlsx")

# Read soil mass and moisture info for air-dry + storage treatment samples
jarinfo.arc <- read.csv("../data/derived/arc-storage-t2-jarInfo/jar_information.csv")

# Read soil mass and moisture info for air-dry data
jarinfo.rewet <- read.csv("../data/derived/air-dry-2019-whc/air-dry-2019-whc_2020-07-03.csv")

# Read soil mass and moisture info for storage duration treatment samples
# remove unit row and convert to appropriate types
jarinfo.tme <- type.convert(read.xlsx("../data/raw/lab_jena_results-co2_2018-07-30/ArcInc_IncData_2018.xlsx", sheet = 1)[-1, ])

# Read Duke iso and flux data
tme.ctl.duk <- read.csv("../data/derived/arc-tme-duke/arc-tme-duke_2020-04-29.csv")

# Read Sierra Nevada (Jun's) soil data
tme.ctl.soil.sra <- read.csv("../data/derived/arc-tme-sierra/arc-tme-sierra-soil_2020-04-29.csv")

# Read Oak Ridge C data
tme.ctl.ornl <- read.csv("../data/derived/arc-tme-ornl/arc-tme-ornl_2020-04-30.csv")

# Read air-dry + storage respiration data
archive.arc.ts <- read.csv("../data/derived/arc-storage-t2-flux/archive-flux-t2_2020-04-24.csv")

# Read control respiration data from 2019 air-dry experiment
rewet.ctl.ts <- read.csv("../data/derived/fresh-2019-flux/fresh-2019-flux_2020-04-24.csv")

# Read treatment respiration data from 2019 air-dry experiment
rewet.dry.ts <- read.csv("../data/derived/dried-2019-flux/dried-2019-flux_2020-04-24.csv")

# Read Sierra Nevada (Jun's) flux data
tme.ctl.flx.sra <- read.csv("../data/derived/arc-tme-sierra/arc-tme-sierra-flux_2020-04-29.csv")

# Read storage duration respiration data
tme.trt.ts <- rbind(read.csv("../data/derived/arc-tme-t2-flux/arc-tme-t2-flux-1_2020-04-27.csv", stringsAsFactors = FALSE),
                        read.csv("../data/derived/arc-tme-t2-flux/arc-tme-t2-flux-2_2020-04-27.csv", stringsAsFactors = FALSE))

# Read miscellaneous storage treatment data
tme.misc <- read.csv("../data/derived/arc-tme-misc/arc-tme-misc-iso_2020-04-29.csv")
```

```{r summarize data, include = FALSE}
# 3. Combine and summarize data in long format to calculate respiration rates and plot over time
# NB: set "include" to false to suppress bind_rows warning about coercing factor to char
# remove formula_check columns
invisible(list2env(lapply(list(archive.arc.ts = archive.arc.ts, 
                               rewet.ctl.ts = rewet.ctl.ts, 
                               rewet.dry.ts = rewet.dry.ts,
                               tme.trt.ts = tme.trt.ts),
                          function(x) {
                            x$formula_check <- NULL
                            return(x)
                            }),
                   envir = .GlobalEnv)
          )

# Add Treatment columns to each dataset
archive.arc.ts$Treatment <- "air-dry + storage"
archive.ctl.ts$Treatment <- "control"
tme.trt.ts$Treatment <- "storage duration"
rewet.ctl.ts$Treatment <- "control"
rewet.dry.ts$Treatment <- "air-dry"

# combine rewet data
rewet.ts <- rbind(rewet.ctl.ts, rewet.dry.ts)
rewet.ts$Experiment <- "rewet"

# add soil dry wt data
archive.arc.ts$dw_g <- jarinfo.arc[match(archive.arc.ts$SampleName, jarinfo.arc$Sample), "Soil.dry.weight_.g."]
archive.ctl.ts$dw_g <- archive.ctl.ts.wide[match(archive.ctl.ts$ID, archive.ctl.ts.wide$ID), "dry_soil_wt_corrected_g"]
rewet.ts <- merge(rewet.ts, jarinfo.rewet[ , c("ID", "Treatment", "dw_g")], by = c("ID", "Treatment"))
tme.trt.ts <- merge(tme.trt.ts, jarinfo.tme[ , c("Nr.", "dry.soil")], by.x = "SampleName", by.y = "Nr.")
colnames(tme.trt.ts)[which(names(tme.trt.ts) == "dry.soil")] <- "dw_g"

# add experiment col to archive.arc.ts, storage.trt.ts
archive.arc.ts$Experiment <- "arc"
tme.trt.ts$Experiment <- "tme"

# combine archive data and Exploratories storage duration data
archive.ts <- rbind(archive.ctl.ts[which(archive.ctl.ts$Experiment != "tme"), ], 
                    archive.arc.ts[ , names(archive.ctl.ts)])
tme.ts <- rbind(archive.ctl.ts[which(archive.ctl.ts$Experiment == "tme"), ],
                tme.trt.ts[ , names(archive.ctl.ts)])

# bind tme.ctl.flx.sra data to tme.ts
# all other tme.flx data is already summarized
tme.ctl.flx.sra$Experiment <- "tme"
tme.ctl.flx.sra$Treatment <- "control"
tme.ctl.flx.sra$dw_g <- tme.ctl.soil.sra[match(tme.ctl.flx.sra$Jar_ID, tme.ctl.soil.sra$Jar_ID), "dw_g"]
tme.ts <- rbind(tme.ts, tme.ctl.flx.sra[ , names(tme.ts)])

# Test that required names are present
nms <- c("SampleName", "ID", "Experiment", "Treatment", "Period", "timepoint_cmtv",  "time_d", "time_d_cmtv", "mgCO2_jar", "dw_g")
invisible(lapply(list(archive.ts = archive.ts,
                      rewet.ts = rewet.ts,
                      tme.ts),
       function(x) {
         ifelse(!is.na(match(nms, names(x))), "yes", "no")
       }
       ))

# combine all data and remove time points without CO2 measurements
ts <- bind_rows(archive.ts[ , nms], rewet.ts[ , nms], tme.ts[ , nms])
if(length(which(is.na(ts$mgCO2_jar))) > 0) {
  ts <- ts[-which(is.na(ts$mgCO2_jar)), ]
}

# add C content
# xplr
ts$gC_gS <- xplr.cn[match(ts$ID, xplr.cn$EP_Plotid), "Total_C"]*10^-3
# duke
ts[which(is.na(ts$gC_gS)), "gC_gS"] <- tme.ctl.duk[match(ts[which(is.na(ts$gC_gS)), "ID"], tme.ctl.duk$ID), "C_g_kg"]*10^-3
# sierras
ts[which(is.na(ts$gC_gS)), "gC_gS"] <- tme.ctl.soil.sra[match(ts[which(is.na(ts$gC_gS)), "ID"], tme.ctl.soil.sra$ID), "gC_kgS"]*10^-3
# oak ridge
ts[which(is.na(ts$gC_gS)), "gC_gS"] <- tme.ctl.ornl[match(ts[which(is.na(ts$gC_gS)), "ID"], tme.ctl.ornl$ID), "C_g_kg"]*10^-3

# add Type
ts$Type <- ifelse(grepl("G", ts$ID), "G", "F")

# calculate CO2 respiration in mgCO2-C per g soil C
# NB: 12/44 = mass ratio of C in CO2
ts$mgCO2.C_gC <- (ts$mgCO2_jar*(12/44))/(ts$dw_g*ts$gC_gS)
ts$mgCO2.C_gC_d <- ts$mgCO2.C_gC/ts$time_d

# summarize CO2 release data for each timepoint, by experiment, treatment, and type
ts.avg <- data.frame(na.omit(ts) %>%
  select(Experiment, Treatment, Type, timepoint_cmtv, mgCO2.C_gC_d, time_d_cmtv)  %>%
  group_by(Experiment, Treatment, Type, timepoint_cmtv) %>%
  add_tally() %>%
  summarise_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(se_slope = mgCO2.C_gC_d_sd/sqrt(n_mean),
         se_slope_l = mgCO2.C_gC_d_mean - se_slope,
         se_slope_u = mgCO2.C_gC_d_mean + se_slope))

# add timepoint zero data
tp0.f <- function(df) {
  tp0 <- df[1, ]
  tp0[ , -which(names(tp0) == "Experiment" | names(tp0) == "Treatment" | names(tp0) == "Type" | names(tp0) == "n")] <- 0
  rbind(tp0, df)
}
ts.avg$treat.Exp <- paste(ts.avg$Treatment, ts.avg$Experiment)
ts.avg <- lapply(split(ts.avg, ts.avg$treat.Exp), function(x) {
  lapply(split(x, x$Type), tp0.f)
  })
ts.avg <- bind_rows(lapply(ts.avg, bind_rows))

# restore classes
ts.avg <- as.data.frame(lapply(ts.avg, type.convert))
```

# Results
## Respiration rates

```{r resp-rate-stats, include = FALSE}
# rewet max resp rates
t.test(
  tapply(ts[ts$Experiment == "rewet" & ts$Treatment == "air-dry" & ts$Period == "pre" & ts$Type == "G", "mgCO2.C_gC_d"],ts[ts$Experiment == "rewet" & ts$Treatment == "air-dry" & ts$Period == "pre" & ts$Type == "G", "SampleName"], max, na.rm = TRUE),
  tapply(ts[ts$Experiment == "rewet" & ts$Treatment == "air-dry" & ts$Period == "pre" & ts$Type == "F", "mgCO2.C_gC_d"],ts[ts$Experiment == "rewet" & ts$Treatment == "air-dry" & ts$Period == "pre" & ts$Type == "F", "SampleName"], max, na.rm = TRUE))
```

*Experiment 1 (air-dry + storage treatment)*

Respiration rates increased dramatically following rewetting for the air-dry + storage treatment in comparison to control samples, similar to what has been observed in other air-dry/rewetting studies [cite]. However, the magnitude and timing of the peak in respiration rates was significantly different between grassland and forest sites [statistics; other forest/grassland studies for comparison?] **(Fig. 3)**.

Among the air-dry + storage samples, respiration rates were more than twice as high in grassland soils than in forest soils, reaching a maximum of `r {round(max(ts.avg2[ts.avg2$Experiment == "arc" & ts.avg2$Treatment == "air-dry + storage" & ts.avg2$Type == "G", "mgCO2.C_gC_d_mean"]),1)}` mg CO~2~ g soil C^-1^ d^-1^ after `r {round(ts.avg2[which(ts.avg2$mgCO2.C_gC_d_mean == max(ts.avg2[ts.avg2$Experiment == "arc" & ts.avg2$Treatment == "air-dry + storage" & ts.avg2$Type == "G", "mgCO2.C_gC_d_mean"])), "time_d_cmtv_mean"]*24,0)}` h, followed by a sharp decline. Mean respiration rates in forest sites peaked at `r {round(max(ts.avg2[ts.avg2$Experiment == "arc" & ts.avg2$Treatment == "air-dry + storage" & ts.avg2$Type == "F", "mgCO2.C_gC_d_mean"]),1)}` mg CO~2~ g soil C^-1^ d^-1^ after `r {round(ts.avg2[which(ts.avg2$mgCO2.C_gC_d_mean == max(ts.avg2[ts.avg2$Experiment == "arc" & ts.avg2$Treatment == "air-dry + storage" & ts.avg2$Type == "F", "mgCO2.C_gC_d_mean"])), "time_d_cmtv_mean"]*24,0)}` h, followed by a much more gradual decline than in grassland sites. Control samples responded more weakly and more gradually to rewetting, although as in the treatment samples respiration was greater in grassland soils than in forest soils. Peak respiration rates for control incubations were `r {round(max(ts.avg2[ts.avg2$Experiment == "arc" & ts.avg2$Treatment == "control" & ts.avg2$Type == "G", "mgCO2.C_gC_d_mean"]),1)}` and `r {round(max(ts.avg2[ts.avg2$Experiment == "arc" & ts.avg2$Treatment == "control" & ts.avg2$Type == "F", "mgCO2.C_gC_d_mean"]),1)}` mg CO~2~ g soil C^-1^ d^-1^ after `r {round(ts.avg2[which(ts.avg2$mgCO2.C_gC_d_mean == max(ts.avg2[ts.avg2$Experiment == "arc" & ts.avg2$Treatment == "control" & ts.avg2$Type == "F", "mgCO2.C_gC_d_mean"])), "time_d_cmtv_mean"]*24,0)}` h for grassland and forest soils, respectively.

*Experiment 2 (air-dry treatment, 2019 samples)*

Respiration rates for the air-dry only treatment samples showed a similarly dramatic increase in comparison to the controls as was observed for the air-dry + storage treatment samples in Experiment 1. However, unlike the air-dry + storage treatment, peak respiration rates were not significantly different (p > 0.05) between forest and grassland soils in Experiment 2, peaking at `r {round(max(ts.avg2[ts.avg2$Experiment == "rewet" & ts.avg2$Treatment == "air-dry" & ts.avg2$Type == "G", "mgCO2.C_gC_d_mean"]),1)}`.0 and `r {round(max(ts.avg2[ts.avg2$Experiment == "rewet" & ts.avg2$Treatment == "air-dry" & ts.avg2$Type == "F", "mgCO2.C_gC_d_mean"]),1)}` mg CO~2~ g soil C^-1^ d^-1^ after `r {round(ts.avg2[which(ts.avg2$mgCO2.C_gC_d_mean == max(ts.avg2[ts.avg2$Experiment == "rewet" & ts.avg2$Treatment == "air-dry" & ts.avg2$Type == "F", "mgCO2.C_gC_d_mean"])), "time_d_cmtv_mean"]*24,0)}` h for grassland and forest soils, respectively **(Fig. 3)**.

*Experiment 3 (storage duration)*

Samples were only incubated for a single enclosure period for this experiment, instead of two (pre-incubation followed by equilibrium respiration). Grassland soils from the storage duration treatment group responded rapidly to rewetting and reached target CO~2~ levels after just `r {round(ts.avg2[which(ts.avg2$mgCO2.C_gC_d_mean == max(ts.avg2[ts.avg2$Experiment == "tme" & ts.avg2$Treatment == "storage duration" & ts.avg2$Type == "G", "mgCO2.C_gC_d_mean"])), "time_d_cmtv_mean"]*24,0)}` h of incubation. Only a single observation was made for the grassland treament samples due to the rapid respiration rates, which peaked at `r {round(max(ts.avg2[ts.avg2$Experiment == "tme" & ts.avg2$Treatment == "storage duration" & ts.avg2$Type == "G", "mgCO2.C_gC_d_mean"]),1)}` mg CO~2~ g soil C^-1^ d^-1^. The mean peak respiration rate for forest treatment samples was lower and lagged in comparison to the grassland soils, reaching `r {round(max(ts.avg2[ts.avg2$Experiment == "tme" & ts.avg2$Treatment == "storage duration" & ts.avg2$Type == "F", "mgCO2.C_gC_d_mean"]),1)}` mg CO~2~ g soil C^-1^ d^-1^ after `r {round(ts.avg2[which(ts.avg2$mgCO2.C_gC_d_mean == max(ts.avg2[ts.avg2$Experiment == "tme" & ts.avg2$Treatment == "storage duration" & ts.avg2$Type == "F", "mgCO2.C_gC_d_mean"])), "time_d_cmtv_mean"]*24,0)}` h.

Conditions for control incubations varied. Grassland control samples were incubated in 2011 under the same conditions as the control samples from Experiment 1, i.e. 96 h pre-incubation period followed by 14 d of equilibrium respiration. Respiration rates peaked after the pre-incubation period (`r {round(ts.avg2[which(ts.avg2$mgCO2.C_gC_d_mean == max(ts.avg2[ts.avg2$Experiment == "tme" & ts.avg2$Treatment == "control" & ts.avg2$Type == "G", "mgCO2.C_gC_d_mean"])), "time_d_cmtv_mean"]*24,0)}` h), at `r {round(max(ts.avg2[ts.avg2$Experiment == "tme" & ts.avg2$Treatment == "control" & ts.avg2$Type == "G", "mgCO2.C_gC_d_mean"]),1)}` mg CO~2~ g soil C^-1^ d^-1^. Forest control samples were pre-incubated under various conditions, but respiration rates were only measured during the pre-incubation period for two samples from the Sierra Nevada mountains (USA). In general, respiration rates for forest control samples in Experiment 3 were much lower than in the treatment incubations, peaking at `r {round(max(ts.avg2[ts.avg2$Experiment == "tme" & ts.avg2$Treatment == "control" & ts.avg2$Type == "F", "mgCO2.C_gC_d_mean"]),1)}` mg CO~2~ g soil C^-1^ d^-1^ after `r {round(ts.avg2[which(ts.avg2$mgCO2.C_gC_d_mean == max(ts.avg2[ts.avg2$Experiment == "tme" & ts.avg2$Treatment == "control" & ts.avg2$Type == "F", "mgCO2.C_gC_d_mean"])), "time_d_cmtv_mean"]*24,0)}` h.

```{r CO2-resp-rates}
# plotted as measured
ts.avg %>%
  filter(Experiment != "tme") %>%
  ggplot(., aes(time_d_cmtv_mean, mgCO2.C_gC_d_mean)) +
  geom_vline(xintercept = 4, color="gray") +
  geom_ribbon(aes(ymin = se_slope_l, ymax = se_slope_u, fill = Type, linetype = Treatment, alpha = Treatment)) +
  geom_point(aes(color = Type, shape = Treatment)) +
  geom_line(aes(color = Type, linetype = Treatment)) +
  facet_grid(rows = vars(Experiment),
             labeller = labeller(Experiment = c("arc" = "2011", "rewet" = "2019"))) +
  scale_x_continuous(limits = c(0,18)) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_fill_manual(name = 'Std. Err.',
                    values =c('F'='#a35513','G'='#1361a3'),
                    labels = c('Forest','Grassland')) +
  scale_alpha_manual(name = 'Treatment',
                     values = c("air-dry + storage" = .2,
                                "control" = .4,
                                "air-dry" = .2)) +
  scale_linetype_manual(name = 'Treatment',
                        values = c("air-dry + storage" = 'dashed',
                                   "control" ='solid',
                                   "air-dry" = "dashed")) +
  scale_shape_manual(name = 'Treatment',
                     values = c("air-dry + storage" = 1,
                                "control" = 16,
                                "air-dry" = 1)) +
  ylab(expression('Respiration Rate (mgCO'[2]*'-C gC'^-1*'d'^-1*')')) +
  xlab("Time (days)") +
  theme_bw() +
  theme(panel.grid = element_blank())

# plot all three experiments
ts.avg %>%
  ggplot(., aes(time_d_cmtv_mean, mgCO2.C_gC_d_mean)) +
  geom_vline(xintercept = 4, color="gray") +
  geom_ribbon(aes(ymin = se_slope_l, ymax = se_slope_u, fill = Type, linetype = Treatment, alpha = Treatment)) +
  geom_point(aes(color = Type, shape = Treatment)) +
  geom_line(aes(color = Type, linetype = Treatment)) +
  facet_grid(rows = vars(Experiment)) +
  scale_x_continuous(limits = c(0,18)) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_fill_manual(name = 'Std. Err.',
                    values =c('F'='#a35513','G'='#1361a3'),
                    labels = c('Forest','Grassland')) +
  scale_alpha_manual(name = 'Treatment',
                     values = c("air-dry + storage" = .2,
                                "control" = .4,
                                "air-dry" = .2,
                                "storage duration" = .2)) +
  scale_linetype_manual(name = 'Treatment',
                        values = c("air-dry + storage" = 'dashed',
                                   "control" ='solid',
                                   "air-dry" = "dashed",
                                   "storage duration" = "dashed")) +
  scale_shape_manual(name = 'Treatment',
                     values = c("air-dry + storage" = 1,
                                "control" = 16,
                                "air-dry" = 1,
                                "storage duration" = 1)) +
  ylab(expression('Respiration Rate (mgCO'[2]*'-C gC'^-1*'d'^-1*')')) +
  xlab("Time (days)") +
  theme_bw() +
  theme(panel.grid = element_blank())
```

>**Fig. `r {(fig.n + 1)}`. Respiration rates for Experiment 1 (air-dry + storage treatment) and Experiment 2 (air-dry only treatment)**

>*Caption:* Top panel shows data from Experiment 1 (air-dry + storage treatment), bottom panel shows data from Experiment 2 (air-dry only treatment). Vertical gray line demarcates the pre-incubation period from the equilibrium respiration period. Points show measurements and lines show trends in mean respiration rates. Shaded ribbons represent the standard error. The final measurement points for a few samples which took >18 days to reach CO~2~ targets are excluded for display reasons. Respiration rates for those samples remained flat. Note that CO~2~ concentrations for control sample incubations in Experiment 1 were only measured once during the pre-incubation period, so rates are shown as the cumulative average. For purposes of comparison, Supplemental Figure 1 shows all data plotted with pre-incubation respiration rates calculated as a cumulative average.

*Supplemental respiration rates figure:*

```{r CO2-flux-plots-SI}
# Note: this code plots data with pre-incubation observations averaged
# Plot resp rates over time
ts.pre <- ts[ts$Period == "pre", ]
ts.pre.avg <- ts.pre %>%
  filter(time_d_cmtv > 3.5) %>%
  select(Experiment, Treatment, Type, timepoint_cmtv, SampleName, mgCO2.C_gC, time_d_cmtv)  %>%
  group_by(Experiment, Treatment, Type, timepoint_cmtv, SampleName) %>%
  summarise_all(list(mean = mean), na.rm = TRUE) %>%
  mutate(mgCO2.C_gC_d = mgCO2.C_gC_mean/time_d_cmtv_mean) %>%
  select(-SampleName, -mgCO2.C_gC_mean, Experiment, Treatment, Type, mgCO2.C_gC_d, time_d_cmtv_mean) %>%
  group_by(Experiment, Treatment, Type) %>%
  add_tally() %>%
  summarise_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(se_slope = mgCO2.C_gC_d_sd/sqrt(n_mean),
         se_slope_l = mgCO2.C_gC_d_mean - se_slope,
         se_slope_u = mgCO2.C_gC_d_mean + se_slope)

ts.inc.avg <- ts %>%
  filter(Period == "inc") %>%
  select(Experiment, Treatment, Type, timepoint_cmtv, mgCO2.C_gC_d, time_d_cmtv)  %>%
  group_by(Experiment, Treatment, Type, timepoint_cmtv) %>%
  add_tally() %>%
  summarise_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(se_slope = mgCO2.C_gC_d_sd/sqrt(n_mean),
         se_slope_l = mgCO2.C_gC_d_mean - se_slope,
         se_slope_u = mgCO2.C_gC_d_mean + se_slope)

colnames(ts.pre.avg)[which(names(ts.pre.avg) %in% c("timepoint_cmtv_mean",
                       "time_d_cmtv_mean_mean",
                       "time_d_cmtv_mean_sd"))] <- c("timepoint_cmtv",
                                                    "time_d_cmtv_mean",
                                                    "time_d_cmtv_sd")

ts.pre.avg <- ts.pre.avg[ , -which(!names(ts.pre.avg) %in% names(ts.inc.avg))]

ts.avg2 <- data.frame(rbind(ts.pre.avg, ts.inc.avg))
ts.avg2 <- ts.avg2[complete.cases(ts.avg2), ]

# add timepoint zero data
ts.avg2$treat.Exp <- paste(ts.avg2$Treatment, ts.avg2$Experiment)
ts.avg2 <- lapply(split(ts.avg2, ts.avg2$treat.Exp), function(x) {
  lapply(split(x, x$Type), tp0.f)
  })
ts.avg2 <- bind_rows(lapply(ts.avg2, bind_rows))

# restore classes
ts.avg2 <- as.data.frame(lapply(ts.avg2, type.convert))

# plot
ts.avg2 %>%
  filter(Experiment != "tme") %>%
  ggplot(., aes(time_d_cmtv_mean, mgCO2.C_gC_d_mean)) +
  geom_vline(xintercept = 4, color="gray") +
  geom_ribbon(aes(ymin = se_slope_l, ymax = se_slope_u, fill = Type, linetype = Treatment, alpha = Treatment)) +
  geom_point(aes(color = Type, shape = Treatment)) +
  geom_line(aes(color = Type, linetype = Treatment)) +
  facet_grid(rows = vars(Experiment),
             labeller = labeller(Experiment = c("arc" = "2011", "rewet" = "2019"))) +
  scale_x_continuous(limits = c(0,18)) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_fill_manual(name = 'Std. Err.',
                    values =c('F'='#a35513','G'='#1361a3'),
                    labels = c('Forest','Grassland')) +
  scale_alpha_manual(name = 'Treatment',
                     values = c("air-dry + storage" = .2,
                                "control" = .4,
                                "air-dry" = .2)) +
  scale_linetype_manual(name = 'Treatment',
                        values = c("air-dry + storage" = 'dashed',
                                   "control" ='solid',
                                   "air-dry" = "dashed")) +
  scale_shape_manual(name = 'Treatment',
                     values = c("air-dry + storage" = 1,
                                "control" = 16,
                                "air-dry" = 1)) +
  ylab(expression('Respiration Rate (mgCO'[2]*'-C gC'^-1*'d'^-1*')')) +
  xlab("Time (days)") +
  theme_bw() +
  theme(panel.grid = element_blank())
```

>**Supplemental Fig `r {(sfig.n <- 1)}`. Respiration rates for Experiment 1 and Experiment 2 shown with all pre-incubation data calculated as cumulative averages**

>*Caption:* CO~2~ concentrations for Experiment 1 control samples were only measured once during the pre-incubation period, in contrast to daily measurements for all other samples. Pre-incubation respiration rates are shown here calculated as cumulative averages for the purpose of fair comparison across all treatments.


## Radiocarbon data

```{r load ams-jena-ingest fx}
# 1. Read in isotope data from various sources
# First load helper function 'read_jena_ams_results.R"
source("./utilities/jena_ams_ingest.R")
```

```{r read iso data}
# 2. Next read in data from the appropriate directories in 'data/raw'
# identify subdirectories in 'raw' directory with "ams_jena" in name
ams_jena_results_dirs <- list.files("../data/raw", pattern = "ams_jena_results", full.names = TRUE)
ams_results_ls <- lapply(seq_along(ams_jena_results_dirs), function(i) {
  read_jena_ams_results(ams_jena_results_dirs[i])
})
names(ams_results_ls) <- list.files("../data/raw", pattern = "ams_jena_results")
```

```{r arc and rewet experiment template}
# 3. Create a "tidy" style template for the data, i.e. variables in columns. 
# Key variables are as follows:
#   * SampleName (incorporates lab rep and treatment, e.g. "HEG10-1_dry")
#   * ID (plot IDs, e.g. for "HEG10" for Exploratory samples)
#   * Treatment (3 treatments: air-dry, air-dry + storage, storage duration; + controls)
#   * Type (2 levels: F = forest, G = grassland)
#   * Period (incubation period, 2 levels: pre = preincubation, inc = equilibrium incubation)
#   * Experiment (3 levels: arc = air-dry + storage, rewet = air-dry/rewet, time = storage duration)
# 
# * Observational columns include:
#   * d14c ($\Delta$^14^C-CO~2~)
#   * d13c ($\delta$^13^C-CO~2~)
#   * C_g_kg (C content)
#   * dw_g (dry weight)
#   * mgCO2.C_gS (mg CO~2~-C respired g^-1^ soil Period^-1^)
#   * time_d (days in incubation period prior to measurement)
#   * dH2O_grav (percent change in gravimetric water content due to laboratory moisture adjustment)
#   * dH2O_whc (percent change in water holding capacity due to laboratory moisture adjustment)
  
unique.id.n <- c(length(unique(archive.ts[archive.ts$Treatment == "control", "SampleName"])),
                 length(unique(archive.ts[archive.ts$Treatment == "air-dry + storage", "SampleName"])),
                 length(unique(rewet.ctl.ts$SampleName)),
                 length(unique(rewet.dry.ts$SampleName)))
pre.14c <- data.frame(SampleName = c(as.character(unique(archive.ts[archive.ts$Treatment == "control", "SampleName"])),
                                     as.character(unique(archive.ts[archive.ts$Treatment == "air-dry + storage", "SampleName"])),
                                     as.character(unique(rewet.ctl.ts$SampleName)),
                                     as.character(unique(rewet.dry.ts$SampleName))))
pre.14c$ID <- substr(pre.14c$SampleName, 1, 5)
pre.14c$Type <- ifelse(grepl("G", pre.14c$ID), "G", "F")
pre.14c$Experiment <- c(rep("arc", unique.id.n[1] + unique.id.n[2]),
                       rep("rewet", unique.id.n[3] + unique.id.n[4]))
pre.14c$Treatment <- c(rep("control", unique.id.n[1]),
                       rep("air-dry + storage", unique.id.n[2]),
                       rep("control", unique.id.n[3]),
                       rep("air-dry", unique.id.n[4]))
pre.14c$Period <- "pre"

# create inc period df as duplicate of pre-inc df, but test that it is the right shape first
if(nrow(pre.14c) == sum(unique.id.n) & ncol(pre.14c) == 6) {
  inc.14c <- pre.14c
  inc.14c$Period <- "inc"
} else {
  "pre.14c data frame malformed"
}
all.14c.template <- rbind(pre.14c, inc.14c)
```

```{r tme experiment template}
unique.id.tme.n <- c(length(unique(tme.ctl.duk$SampleName)),
                     length(unique(tme.ctl.ornl$SampleName)),
                     length(unique(tme.ctl.flx.sra$SampleName)),
                     length(unique(tme.misc$SampleName)),
                     length(unique(archive.ctl.ts.wide[archive.ctl.ts.wide$Experiment == "tme", "ID"])),
                     length(unique(tme.trt.ts$SampleName)))
pre.tme.ctl <- data.frame(SampleName = c(as.character(unique(tme.ctl.duk$SampleName)),
                                         as.character(unique(tme.ctl.ornl$SampleName)),
                                         as.character(unique(tme.ctl.flx.sra$SampleName)),
                                         as.character(unique(tme.misc$SampleName)),   as.character(unique(archive.ctl.ts.wide[archive.ctl.ts.wide$Experiment == "tme", "ID"]))))
pre.tme.ctl$Site <- c(rep("Duke", unique.id.tme.n[1]),
                      rep("ORNL", unique.id.tme.n[2]),
                      rep("Sierra", unique.id.tme.n[3]),
                      rep("misc", unique.id.tme.n[4]),
                      rep("Xplr", unique.id.tme.n[5]))


# Duke, ORNL, misc, and Xplr IDs
pre.tme.ctl[pre.tme.ctl$Site == "Duke" | 
            pre.tme.ctl$Site == "ORNL" |
            pre.tme.ctl$Site == "misc" |
            pre.tme.ctl$Site == "Xplr", "ID"] <- as.character(pre.tme.ctl[pre.tme.ctl$Site == "Duke" |
                                                                            pre.tme.ctl$Site == "ORNL" |
                                                                            pre.tme.ctl$Site == "misc" |
            
                                                                            pre.tme.ctl$Site == "Xplr", "SampleName"])

# Sierra IDs
pre.tme.ctl[pre.tme.ctl$Site == "Sierra", "ID"] <-
  substr(pre.tme.ctl[pre.tme.ctl$Site == "Sierra", "SampleName"], 10, 11)

# subdivide ORNL into WB and TVA
pre.tme.ctl[pre.tme.ctl$Site == "ORNL", "Site"] <- ifelse(grepl("TVA", pre.tme.ctl[pre.tme.ctl$Site == "ORNL", "ID"]), "Tennessee Valley", "Walker Branch")

# subdivide Sierra into Musick and Shaver
pre.tme.ctl[pre.tme.ctl$Site == "Sierra", "Site"] <- ifelse(grepl("M", pre.tme.ctl[pre.tme.ctl$Site == "Sierra", "ID"]), "Musick", "Shaver")

# add treatment col
pre.tme.ctl$Treatment <- "control"

pre.tme.trt <- data.frame(SampleName = unique(tme.trt.ts$SampleName))
pre.tme.trt$ID <- substr(pre.tme.trt$SampleName, 1, nchar(as.character(pre.tme.trt$SampleName))-2)
pre.tme.trt <- rbind(pre.tme.trt, pre.tme.ctl[pre.tme.ctl$Site == "misc", c("ID", "SampleName")])
pre.tme.trt$Treatment <- "storage duration"
pre.tme.trt$Site <- pre.tme.ctl[match(pre.tme.trt$ID, pre.tme.ctl$ID), "Site"]

pre.tme.14c <- rbind(pre.tme.ctl, pre.tme.trt)
pre.tme.14c$Type <- ifelse(grepl("G", pre.tme.14c$SampleName), "G", "F")
pre.tme.14c$Period <- "pre"
pre.tme.14c$Experiment <- "tme"

# create inc period df
inc.tme.14c <- pre.tme.14c
inc.tme.14c$Period <- "inc"
tme.14c.template <- rbind(pre.tme.14c, inc.tme.14c)
```

```{r combine soil obs data}
# 4. Summarize observational data from timeseries data by unique IDs (SampleName)
# summarize time and co2 data by experiment, period, treatment, and sample name
ts.epsn.avg <- ts %>%
  select(Experiment, ID, Period, Treatment, SampleName, gC_gS, dw_g, mgCO2.C_gC, time_d, time_d_cmtv)  %>%
  group_by(Experiment, ID, Period, Treatment, SampleName) %>%
  summarise_all(list(max = max), na.rm = TRUE)
ts.epsn.avg <- rename_at(ts.epsn.avg, vars(contains('max')), list(~sub("_max", "", .)))
```

```{r clean up 14C data}
# 6. Clean up ^14^C data and add external data points (tme experiment, Xplr control samples)
# Need to add SampleName col and variable columns Treatment, Period, and Experiment to all data frames in ams_results_ls 

# First add 14C and 13C data from Exploratories control samples to ams_results_ls
# note that neither 13C nor 14C was measured for the pre-incubation period for these samples
# get names for ams_results data frames
results.14c.nms <- names(ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`)
# get names for relevant Experiment/Treatment/Period combination
arc_ctl_inc_SN <- as.character(all.14c.template[all.14c.template$Experiment == "arc" & all.14c.template$Treatment == "control" & all.14c.template$Period == "inc", "SampleName"])
tme_ctl_inc_xplr_SN <- unlist(lapply(ams_results_ls[1:2], function(x) unlist(lapply(x, "[[", "Probe"))))
tme_ctl_inc_xplr_SN <- tme_ctl_inc_xplr_SN[grep("HE", tme_ctl_inc_xplr_SN)]
if(length(tme_ctl_inc_xplr_SN) == 14) {
  tme_ctl_inc_xplr_SN <- unique(substr(tme_ctl_inc_xplr_SN, 1, nchar(tme_ctl_inc_xplr_SN)-2))
}

# add sublist for Exploratories 2011 (control) data and data frames for above subsets
ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc <- data.frame(matrix(nrow = length(arc_ctl_inc_SN), ncol = length(results.14c.nms)))
ams_results_ls$exploratories_ischoening_14c.co2_2011$tme_ctl_inc_xplr <- data.frame(matrix(nrow = length(tme_ctl_inc_xplr_SN), ncol = length(results.14c.nms)))

# add names and fill SampleNames for new data frames
ams_results_ls$exploratories_ischoening_14c.co2_2011 <- lapply(ams_results_ls$exploratories_ischoening_14c.co2_2011, function(x) {
  names(x) <- results.14c.nms
  return(x)
  }) 
ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc[ , c("SampleName","Probe")] <- arc_ctl_inc_SN
ams_results_ls$exploratories_ischoening_14c.co2_2011$tme_ctl_inc_xplr[ , c("SampleName","Probe")] <- tme_ctl_inc_xplr_SN

# fill 14C data
ams_results_ls$exploratories_ischoening_14c.co2_2011 <- lapply(ams_results_ls$exploratories_ischoening_14c.co2_2011, function(df) {
  df$`âˆ†14C.(â€°)` <- xplr.ctl.iso[match(df$Probe, xplr.ctl.iso$EP_Plotid), "14c_CO2"]
  df$Treatment <- "control"
  df$Period <- "inc"
  return(df)
})

# add Experiment
ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc$Experiment <- "arc"
ams_results_ls$exploratories_ischoening_14c.co2_2011$tme_ctl_inc_xplr$Experiment <- "tme"


# `ams_jena_results-co2_2018-10-12` and `ams_jena_results-co2_2018-11-09`
# `Beem-Miller_4.xlsx`, `Beem-Miller_5.xlsx`; `Beem-Miller_6.xlsx`, `Beem-Miller_7.xlsx`
# Add treatment, experiment, period cols
# Experiment = tme
# Treatment = storage duration
# Period = inc
ams_results_ls[1:2] <- lapply(ams_results_ls[1:2], function(ls) lapply(ls, function(df) {
  df$Experiment <- "tme"
  df$Treatment <- "storage duration"
  df$Period <- "inc"
  return(df)
  })
)

# `ams_jena_results-co2_2019-01-28`
# `Beem-Miller_9.xlsx`
# Experiment = arc
# Treatment = air-dry + storage
# Period = pre
ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`$SampleName <- ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`$Probe
ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`$Treatment <- "air-dry + storage"
ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`$Period <- "pre"
ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`$Experiment <- "arc"

# ams_results_ls$`ams_jena_results-co2_2019-02-25`$
# Archived_Incubations_30.xlsx
# Experiment = arc
# Treatment = air-dry + storage
# Period = inc
ams_results_ls$`ams_jena_results-co2_2019-02-25`$Archived_Incubations_30.xlsx$SampleName <- substr(ams_results_ls$`ams_jena_results-co2_2019-02-25`$Archived_Incubations_30.xlsx$Probe, 1, 9)
ams_results_ls$`ams_jena_results-co2_2019-02-25`$Archived_Incubations_30.xlsx$Treatment <- "air-dry + storage"
ams_results_ls$`ams_jena_results-co2_2019-02-25`$Archived_Incubations_30.xlsx$Period <- "inc"
ams_results_ls$`ams_jena_results-co2_2019-02-25`$Archived_Incubations_30.xlsx$Experiment <- "arc"

# ams_results_ls$`ams_jena_results-co2_2019-04-30`
# `Rost_31-2.xlsx`
# Experiment = arc
# Treatment = air-dry + storage
# Period = inc, pre (SEW11-2-2)
ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`$SampleName <- substr(ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`$Probe, 1, 9)
ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`$Treatment <- "air-dry + storage"
ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`$Experiment <- "arc"
ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`[2:9, "Period"] <- "inc"
ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`[10, "Period"] <- "pre"

# ams_results_ls$`ams_jena_results-co2_2020-02-13`
# Rost_47.xlsx 
# Experiment = rewet
# Treatment = control
# Period = pre
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_47.xlsx$SampleName <- substr(ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_47.xlsx$Probe, 1, 7)
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_47.xlsx$Treatment <- "control"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_47.xlsx$Experiment <- "rewet"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_47.xlsx$Period <- "pre"
# Rost_50.xlsx
# Experiment = rewet
# Treatment = control
# Period = inc
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_50.xlsx$SampleName <- substr(ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_50.xlsx$Probe, 1, 7)
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_50.xlsx$Treatment <- "control"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_50.xlsx$Experiment <- "rewet"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_50.xlsx$Period <- "inc"
# Rost_52.xlsx
# Experiment = rewet
# Treatment = air-dry
# Period = pre, inc
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx$SampleName <- substr(ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx$Probe, 1, 11)
pre.ix <- which(grepl("PRE", ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx$Probe))
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx$Treatment <- "air-dry"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx$Experiment <- "rewet"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx[pre.ix, "Period"] <- "pre"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx[-pre.ix, "Period"] <- "inc"
```

```{r combine 14C soil obs data}
# 7. Combine data.
# flatten list and remove AMS blanks, NA samples, and non-Exploratory data
ams_results_arc_rewet <- lapply(ams_results_ls[3:7], function(x) bind_rows(x))
ams_results_arc_rewet.df <- bind_rows(lapply(ams_results_arc_rewet, function(x) extra.clean.fx(x)))

# flatten external data list
ams_results_tme <- lapply(ams_results_ls[c(1:2,7)], function(x) lapply(x, tme.14c.fx))
ams_results_tme.df <- bind_rows(lapply(ams_results_tme, function(x) bind_rows(x)))

# cut out non-relevant AMS results columns
nms.ams.vars <- c("F14C", "err", "âˆ†14C.(â€°)", "err.(â€°)",
                 "SampleName", "Treatment", "Period", "Experiment")
ams_results_arc_rewet.df <- ams_results_arc_rewet.df[ , nms.ams.vars]
colnames(ams_results_arc_rewet.df) <- c("fm", "fm_err", "d14c", "d14c_err", nms.ams.vars[5:8])

ams_results_tme.df <- ams_results_tme.df[ , nms.ams.vars]
colnames(ams_results_tme.df) <- c("fm", "fm_err", "d14c", "d14c_err", nms.ams.vars[5:8])
ams_results_tme.df$ID <- substr(ams_results_tme.df$SampleName, 1, nchar(ams_results_tme.df$SampleName)-2)
ams_results_tme.df$Type <- ifelse(grepl("G", ams_results_tme.df$ID), "G", "F")

# merge arc and rewet 14C data with template
if(nrow(merge(all.14c.template, ams_results_arc_rewet.df, all.x = TRUE)) == nrow(all.14c.template)) {
  all.14c <- merge(all.14c.template, ams_results_arc_rewet.df, all.x = TRUE)
} else {
  cat("duplicate sample merge error")
}

# merge soil obs data with 14c data
if(nrow(merge(all.14c, ts.epsn.avg, by = c("SampleName", "Period"))) == nrow(all.14c)) {
  all.14c <- merge(all.14c, ts.epsn.avg, all.x = TRUE)
} else {
  cat("duplicate sample merge error")
}

# merge tme 14C data with template and ts.epsn.avg
tme.14c <- merge(tme.14c.template, ams_results_tme.df, all.x = TRUE)

# add ctl sample 14C data to tme.14c
# first remove NA values
tme.14c.clean <- tme.14c[which(!is.na(tme.14c$d14c) | !is.na(tme.14c$fm)), ]
# define merge fx
tme.mrg.fx <- function(x, y) {
  mrg.nms <- c("SampleName", "ID", "Treatment", "Period")
  var.nms <- c("YearSampled", "Site", "Horizon",  "d14c", "fm")
  if(length(grep("fm", names(y))) > 0) {
    df <- merge(x[ , mrg.nms], y[ , c(mrg.nms, var.nms)])
  } else {
    df <- merge(x[ , mrg.nms], y[ , c(mrg.nms, var.nms[1:4])])
    df$fm <- NA
  }
  return(df)
}

tme.14c.df <- bind_rows(lapply(list(tme.ctl.duk,
                               tme.ctl.flx.sra[which(!is.na(tme.ctl.flx.sra$d14c)), ],
                               tme.ctl.ornl,
                               tme.misc), function(i) tme.mrg.fx(tme.14c, i)))

# add storage duration data for treatment samples analyzed externally
tme.14c.df$Type <- "F"

# add YearSampled for tme.14c.clean samples
for(i in 1:nrow(tme.14c.clean)) {
  if(tme.14c.clean[i, "Site"] == "Duke") {
    tme.14c.clean[i, "YearSampled"] <- 2008
  } else if(tme.14c.clean[i, "Site"] == "Xplr") {
    tme.14c.clean[i, "YearSampled"] <- 2011
  } else if(tme.14c.clean[i, "Site"] == "Sierra") {
    tme.14c.clean[i, "YearSampled"] <- 2009
  } else {
    tme.14c.clean[i, "YearSampled"] <- 2004
  }
}

# Add Horizon to tme.14c.clean
tme.14c.clean$Horizon <- ifelse(tme.14c.clean$ID == "MB" | tme.14c.clean$ID == "SB", "B", "A")

# combine tme data
tme.14c <- bind_rows(tme.14c.clean[ , names(tme.14c.df)], tme.14c.df)
tme.14c$Experiment <- "tme"

# remove outlier (MA-1)
# *** Need to clarify method for determining that this is an outlier *** 
tme.14c <- tme.14c[-which(tme.14c$SampleName == "MA-1" | tme.14c$SampleName == "HEW49-1" | tme.14c$SampleName == "HEW26-1"), ]


# Add missing variable columns to all.14c
# add YearSampled column
all.14c$YearSampled <- ifelse(all.14c$Experiment == "arc", 2011, 2019)

# add Site and Horizon columns
all.14c$Site <- ifelse(grepl("HE", all.14c$ID), "Hainich", "Schorfheide")
all.14c$Horizon <- "A"


# combine tme.14c and all.14c into a list and calculate fraction modern from d14C as needed
all.14c.ls <- lapply(list(tme.14c, all.14c), function(df) {
  df$fm <- ifelse(is.na(df$fm),
                  d14c.fm.fx(df$YearSampled, df$d14c),
                  df$fm)
  df$d14c_corr <- decay.corr.fx(df$YearSampled, df$fm)
  return(df)
})

all.14c.sum <- lapply(all.14c.ls, function(df) {
  df.sum <- select(df, -SampleName) %>%
    group_by(ID, Type, Period, Treatment, Experiment, Site, Horizon, YearSampled) %>%
    summarise_all(list(mean = mean, max = max, min = min), na.rm = TRUE)
  df.sum[mapply(is.infinite, df.sum)] <- NA
  return(df.sum)
})
all.14c.sum <- rapply(all.14c.sum, f = function(x) ifelse(is.nan(x), NA , x), how = "replace")
all.14c.sum.df <- bind_rows(all.14c.sum)

# remove unnecessary objects
```

```{r read-calc-13c}
# 13C data is not as standardized as 14C data, so need to read in individually
# since data is .xls format, data is first converted to .csv

```


```{r counts for checking plots, include = FALSE}
# 8. Count number of ^14^C observations for checking plots.
# count !is.na(14C) cases by SampleName
all.14c[-which(is.na(all.14c$d14c_corr)),] %>%
  group_by(Experiment, Treatment, Period, Type) %>%
  count()
# by ID
all.14c[-which(is.na(all.14c$d14c_corr)),] %>%
  group_by(Experiment, Treatment, Period, Type) %>%
  distinct(ID) %>%
  count()
```

*Pre-incubation versus equilibrium respiration ^14^C-CO~2~*

Despite the significant differences in respiration, and in contrast to hypothesis 1, we did not observe significant differences between ^14^C-CO~2~ respired during the pre-incubation period and ^14^C-CO~2~ respired during the equilibrium respiration period: neither for the air-dry + storage treatment nor for the air-dry treatment alone **(Fig. 5)**. The interactions with land use was not significant nor was the interaction with experiment, so all data were pooled for statistical analysis.

```{r pre-inc-14c-plot}
all.14c.pre.inc <- merge(all.14c.sum.df[all.14c.sum.df$Period == "pre", c("ID", "Experiment", "Type", "Treatment", "d14c_corr_mean", "d14c_corr_min", "d14c_corr_max")],
                         all.14c.sum.df[all.14c.sum.df$Period == "inc", c("ID", "Experiment", "Type", "Treatment", "d14c_corr_mean", "d14c_corr_min", "d14c_corr_max")],
                         by = c("ID", "Experiment", "Type", "Treatment"),
                         suffixes = c("_pre", "_inc"))
all.14c.pre.inc$treat.bi <- ifelse(all.14c.pre.inc$Treatment == "control", "control", "treatment")

all.14c.pre.inc %>%
  filter(Experiment != "tme") %>%
  ggplot(., aes(d14c_corr_mean_pre, d14c_corr_mean_inc, color = Type, shape = Treatment)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_vline(xintercept = 0, color = "gray") +
  geom_hline(yintercept = 0, color = "gray") +
  geom_point(size = 3) +
  geom_errorbar(
    aes(ymin = d14c_corr_min_inc, 
        ymax = d14c_corr_max_inc, 
        color = Type), 
    width = .25) +
  geom_errorbarh(
    aes(xmin = d14c_corr_min_pre, 
        xmax = d14c_corr_max_pre, 
        color = Type), 
    height = .9) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Treatment',
                     values = c("control" = 16,
                                "air-dry" = 1,
                                "air-dry + storage" = 0)) +
  scale_x_continuous(limits = c(-60, 115)) +
  scale_y_continuous(limits = c(-60, 115)) +
  xlab(expression('Pre-incubation '*Delta*''^14*'C (â€°)')) +
  ylab(expression('Equilibrium respiration '*Delta*''^14*'C (â€°)')) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.key.height=unit(.8, "cm"),
        aspect.ratio = 1)
```
>**Fig. `r {fig.n + 2}`. Pre-incubation period $\Delta$^14^C against equilibrium respiration period $\Delta$^14^C**

>*Caption:* Points are means of laboratory duplicates and error bars are the min and max (except for Experiment 1 control samples, which were not replicated). Note that pre-incubation $\Delta$^14^C was not measured for the Experiment 1 control samples; additionally samples from three of the forest plots of the Experiment 1 treatment samples (air-dry + storage) failed to accumulate enough CO~2~ during the pre-incubation period to measure ^14^C. The outlier point with the substantially depleted pre-incubation $\Delta$^14^C is from Experiment 2 (control).

Note the one outlier (forest, control) for which the pre-incubation CO~2~ was substantially depleted relative to equilibrium period respiration. However, even when this outlier was included in the statistical analysis the difference between pre-incubation ^14^C-CO~2~ and equilibrium ^14^C-CO~2~ was not significant. For clarity, this point will be excluded from the future plots. Due to lower respiration rates during pre-incubation, only three of the six forest samples in Experiment 1 generated enough CO~2~ to measure radiocarbon, and additionally, it was not possible to compare pre-incubation and equilibrium respiration ^14^C-CO~2~ for the control samples in Experiment 1 since pre-incubation ^14^C-CO~2~ was not measured for these samples in 2011.

```{r pre-equ-14c-stats, include = FALSE}
# gather pre and inc data from all reps, arc and rewet exp only
j.vars <- c("SampleName", "ID", "Experiment", "Treatment", "Type", "d14c_corr", "mgCO2.C_gC")
arc.rewet.pre.14c <- bind_rows(lapply(all.14c.ls, function(df) {
  if(!is.null(df$mgCO2.C_gC)) {
      df <- df[which(df$Period == "pre" & df$Experiment != "tme"), j.vars]
  return(df)
  }
}))
arc.rewet.inc.14c <- bind_rows(lapply(all.14c.ls, function(df) {
  if(!is.null(df$mgCO2.C_gC)) {
  df <- df[which(df$Period == "inc" & df$Experiment != "tme"), j.vars]
  return(df)
  }
}))
arc.rewet.14c <- merge(arc.rewet.pre.14c, arc.rewet.inc.14c, by = j.vars[1:5], suffixes = c("_pre", "_inc"))

arc.rewet.14c$treat.bi <- ifelse(arc.rewet.14c$Treatment == "control", "control", "treatment")

## look at interactions
# Experiment 1
# interaction with Type ns
summary(lm(d14c_corr_inc ~ d14c_corr_pre * Type, arc.rewet.14c[arc.rewet.14c$Experiment == "arc", ]))

# Experiment 2
# interaction with Type * Treatment significant due to outlier
summary(lm(d14c_corr_inc ~ d14c_corr_pre * Type * Treatment, arc.rewet.14c[arc.rewet.14c$Experiment == "rewet", ]))
# but disappears when excluded
summary(lm(d14c_corr_inc ~ d14c_corr_pre * Type * Treatment, arc.rewet.14c[which(arc.rewet.14c$Experiment == "rewet" & arc.rewet.14c$ID != "HEW22"), ]))

# combined
summary(lm(d14c_corr_inc ~ d14c_corr_pre * Experiment * Type * treat.bi, arc.rewet.14c)) # outlier
summary(lm(d14c_corr_inc ~ d14c_corr_pre * Experiment * Type * treat.bi, 
           arc.rewet.14c[-which(arc.rewet.14c$ID == "HEW22"), ])) # w/o HEW22

# t.test
t.test(arc.rewet.14c$d14c_corr_pre, arc.rewet.14c$d14c_corr_inc) # w/ HEW22
t.test(arc.rewet.14c[-which(arc.rewet.14c$ID == "HEW22"), "d14c_corr_pre"], 
       arc.rewet.14c[-which(arc.rewet.14c$ID == "HEW22"), "d14c_corr_inc"]) # w/o HEW22
rm(j.vars)
```

*Treatment effects on observed equilibrium period ^14^C-CO~2~*

```{r ctl-trt-difs, include = FALSE}
# average control and treatment data
# remove HEW22 control pre
# note that upper/lower limits = 2xSE
all.14c.sum2 <- all.14c.ls[[2]] %>%
  mutate(ID.treat.Period = paste(ID, Treatment, Period)) %>%
  filter(ID.treat.Period != "HEW22 control pre") %>%
  select(Type, Period, Treatment, Experiment, YearSampled, d14c_corr, mgCO2.C_gC) %>%
  group_by(Type, Period, Treatment, Experiment, YearSampled) %>%
  add_count() %>%
  summarize_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(d14c_corr_se = d14c_corr_sd/n_mean,
         d14c_corr_u = d14c_corr_mean + d14c_corr_se*2,
         d14c_corr_l = d14c_corr_mean - d14c_corr_se*2,
         mgCO2.C_gC_se = mgCO2.C_gC_sd/n_mean,
         mgCO2.C_gC_u = mgCO2.C_gC_mean + mgCO2.C_gC_se*2,
         mgCO2.C_gC_l = mgCO2.C_gC_mean - mgCO2.C_gC_se*2) 

all.14c.sum2$treat.bi <- ifelse(all.14c.sum2$Treatment == "control", "control","treatment")

# summarize
trt.ctl.df <- merge(
  all.14c.sum2[which(all.14c.sum2$treat.bi == "control" & all.14c.sum2$Period == "inc"), c("Type", "Experiment", "d14c_corr_mean", "d14c_corr_sd", "n_mean")],
  all.14c.sum2[which(all.14c.sum2$treat.bi != "control" & all.14c.sum2$Period == "inc"), c("Type", "Experiment", "d14c_corr_mean", "d14c_corr_sd", "n_mean")],
  by = c("Type", "Experiment"),
  suffixes = c(".ctl", ".trt"))
trt.ctl.df$dif <- trt.ctl.df$d14c_corr_mean.ctl - trt.ctl.df$d14c_corr_mean.trt
trt.ctl.df$dif.se <- sapply(split(trt.ctl.df, 1:nrow(trt.ctl.df)), function(x) {
  sqrt(sum((x$d14c_corr_sd.ctl)^2/sqrt(x$n_mean.ctl),
      (x$d14c_corr_sd.trt)^2/sqrt(x$n_mean.trt)))
  })
trt.ctl.df$dif.sd <- sapply(split(trt.ctl.df, 1:nrow(trt.ctl.df)), function(x) {
  sqrt(sum(x$d14c_corr_sd.ctl^2/x$n_mean.ctl,
           x$d14c_corr_sd.trt^2/x$n_mean.trt))
  })

# calculate differences within treatment groups, i.e. ctl 2011 - ctl 2019, etc.
# forests
f.ctl.dif <- trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "F", "d14c_corr_mean.ctl"] - trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "F", "d14c_corr_mean.ctl"]
f.ctl.dif.sd <- sqrt(trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "F", "d14c_corr_sd.ctl"]^2/trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "F", "n_mean.ctl"] + trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "F", "d14c_corr_sd.ctl"]^2/trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "F", "n_mean.ctl"])
f.trt.dif <- trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "F", "d14c_corr_mean.trt"] - trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "F", "d14c_corr_mean.trt"]
f.trt.dif.sd <- sqrt(trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "F", "d14c_corr_sd.trt"]^2/trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "F", "n_mean.trt"] + trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "F", "d14c_corr_sd.trt"]^2/trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "F", "n_mean.trt"])

# grasslands
g.ctl.dif <- trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "G", "d14c_corr_mean.ctl"] - trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "G", "d14c_corr_mean.ctl"]
g.ctl.dif.sd <- sqrt(trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "G", "d14c_corr_sd.ctl"]^2/trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "G", "n_mean.ctl"] + trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "G", "d14c_corr_sd.ctl"]^2/trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "G", "n_mean.ctl"])
g.trt.dif <- trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "G", "d14c_corr_mean.trt"] - trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "G", "d14c_corr_mean.trt"]
g.trt.dif.sd <- sqrt(trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "G", "d14c_corr_sd.trt"]^2/trt.ctl.df[trt.ctl.df$Experiment == "arc" & trt.ctl.df$Type == "G", "n_mean.trt"] + trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "G", "d14c_corr_sd.trt"]^2/trt.ctl.df[trt.ctl.df$Experiment == "rewet" & trt.ctl.df$Type == "G", "n_mean.trt"])

# atm
atm.dif <- Datm[Datm$Date == 2011.5, "NHc14"] - Datm[Datm$Date == 2019.5, "NHc14"]

dif.time.df <- data.frame(dif = c(f.ctl.dif, f.trt.dif, g.ctl.dif, g.trt.dif, atm.dif),
                          sd = c(f.ctl.dif.sd, f.trt.dif.sd, g.ctl.dif.sd, g.trt.dif.sd, NA),
                          Type = c(rep(c("F","G"), each = 2), "atm"),
                          Treatment = c(rep(c("Ctl","Trt"), 2), "NA"))
```

Relative to the controls the air-dry + storage treatment (Experiment 1, open squares in **Fig. 4**) led to enrichment in grassland samples, but depletion in forest samples. In contrast, the air-dry only treatment (Experiment 2, open circles, **Fig. 4**) led to enrichment for both forest and grassland samples (2019 points). Treatment effects on ^14^C-CO~2~ were signifcant for both forests and grassland soils in Experiment 1 (2011 points, **Fig. 4**), and significant for grassland samples but not forest samples in Experiment 2 (2019 points, **Fig. 4**). The absolute mean difference in ^14^C-CO~2~ between control and treatment samples was greater in grassland samples (`r {round(mean(abs(trt.ctl.df[trt.ctl.df$Type == "G", "d14c_corr_mean.ctl"] - trt.ctl.df[trt.ctl.df$Type == "G", "d14c_corr_mean.trt"])), 1)}`â€°) than in forest samples (`r {round(mean(abs(trt.ctl.df[trt.ctl.df$Type == "F", "d14c_corr_mean.ctl"] - trt.ctl.df[trt.ctl.df$Type == "F", "d14c_corr_mean.trt"])), 1)}`â€°) for both experiments. 

Mean ^14^C-CO~2~ showed enrichment relative to the atmosphere for all samples in both experiments. Control sample ^14^C-CO~2~ respired from grassland soils was generally closer to the atmosphere than that from forest soil controls, but the difference from the atmosphere ($\Delta$$\Delta$^14^C) increased slightly between 2011 and 2019 in grassland soils while it stayed about the same in forest soils. 

```{r treatment effects by time}
# first load atmospheric data from ISRaD and bind future projection
Datm <- rbind(graven, future14C)
Datm <- Datm[Datm$Date > 1900, c("Date", "NHc14")]

# # code for plotting data by ID
# all.14c.sum %>%
#   filter(Period == "inc") %>%
#   filter(!grepl("S", ID)) %>%
#   mutate(year.ID = paste(YearSampled, ID)) %>%
#   ggplot(., aes(YearSampled, d14c_corr_mean, color = Type)) +
#   geom_point(aes(shape = Treatment), size = 3) +
#   geom_path(aes(group = year.ID), 
#             arrow = arrow(type = "open", length = unit(.1, "inches"), ends = "last"),
#             show.legend = FALSE) +
#   geom_path(data = Datm, aes(Date, NHc14), color = "darkgray") +
#   scale_color_manual(name = 'Land use',
#                      values =c('F'='#a35513','G'='#1361a3'),
#                      labels = c('Forest','Grassland')) +
#   scale_shape_manual(name = 'Treatment',
#                      values = c("air-dry" = 1, 
#                                 "air-dry + storage" = 0,
#                                 "control" = 16)) +
#   scale_x_continuous(limits = c(2010, 2020), breaks = c(2013, 2016, 2019)) +
#   scale_y_continuous(limits = c(-15, 100)) +
#   xlab('Year sampled') +
#   ylab(expression('mean '*Delta*''^14*'C (â€°)')) +
#   facet_wrap(~ ID, ncol = 3) +
#   theme_bw() +
#   theme(panel.grid = element_blank())

# plot over time, averaged by Type
all.14c.sum2 %>%
  filter(Period == "inc") %>%
  mutate(year.Type = paste(YearSampled, Type)) %>%
  ggplot(., aes(YearSampled, d14c_corr_mean, color = Type)) +
  geom_point(aes(shape = Treatment), size = 3, stroke = 1.5) +
  geom_path(aes(group = year.Type), 
            arrow = arrow(type = "open", length = unit(.1, "inches"), ends = "first"),
            show.legend = FALSE,
            position = position_dodge(width = 2, preserve = "single"),
            size = 1.2) +
  geom_path(data = Datm, aes(Date, NHc14), color = "darkgray") +
  geom_errorbar(
    aes(ymin = d14c_corr_l, 
        ymax = d14c_corr_u, 
        color = Type), 
    width = .5,
    alpha = .3) +
  scale_color_manual(name = 'Land use',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Treatment',
                     values = c("air-dry" = 1, 
                                "air-dry + storage" = 0,
                                "control" = 16)) +
  scale_x_continuous(limits = c(2010, 2020), breaks = c(2013, 2016, 2019)) +
  scale_y_continuous(limits = c(-15, 100)) +
  xlab('Year sampled') +
  ylab(expression('mean '*Delta*''^14*'C (â€°)')) +
  facet_grid(cols = vars(Type)) +
  theme_bw() +
  theme(panel.grid = element_blank())
# Fig. 1 shows the direction of mean treatment effects over time in reference to the atmosphere (gray line). Points are means (n = 12 for 2011 treatment points, n = 9 for 2011 control points; n = 6 for all 2019 points); error bars = 2x std. err. of the mean.
```
>**Fig `r {fig.n + 3}`. Treatment effect on observed $\Delta$^14^C-CO~2~ over time (Experiments 1 and 2)**

>*Caption:* Filled circles show ^14^C-CO~2~ observed for control samples, while open symbols show ^14^C-CO~2~ observed for treament samples (open squares = air-dry + storage treatment, Experiment 1; open circles = air-dry only treatment, Experiment 2). Arrows show the direction of change in ^14^C-CO~2~ relative to the controls. Points are means and error bars show 2x standard error. The gray line shows $\Delta$^14^C of the atmosphere.

```{r side-by-side plot, include = FALSE}
# plot as side-by-side means w/ 2xSE
# will change to 95%CIs at some point, but need to calculate test statistic with appropriate df
all.14c.sum2 %>%
  filter(Period == "inc") %>%
  ggplot(., aes(treat.bi, d14c_corr_mean, color = Type)) +
  geom_point(aes(shape = Treatment), size = 3) +
  geom_errorbar(
    aes(ymin = d14c_corr_u, 
        ymax = d14c_corr_l, 
        color = Type), 
    width = .1) +
  scale_color_manual(name = 'Land use',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Treatment',
                     values = c("air-dry" = 1, 
                                "air-dry + storage" = 0,
                                "control" = 16)) +
  ylab(expression('mean '*Delta*''^14*'C (â€°)')) +
  facet_grid(cols = vars(Type), rows = vars(YearSampled)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank())

```


*Effect of cumulative respired carbon on ^14^C-CO~2~*

```{r ctl-trt-stats, include = FALSE}
# calculate difs ctl-trt, look at effect of C resp
arc.rewet.inc.14c$treat.bi <- ifelse(arc.rewet.inc.14c$Treatment == "control", "control", "treatment")
arc.rewet.inc.14c.sum <- arc.rewet.inc.14c %>%
  group_by(ID, Experiment, Type, treat.bi) %>%
  summarize_if(is.numeric, mean, na.rm = TRUE)

j.vars <- c("ID", "Experiment", "Type", "d14c_corr", "mgCO2.C_gC")
arc.rewet.14c.ctl.trt <- left_join(
  arc.rewet.inc.14c.sum[arc.rewet.inc.14c.sum$treat.bi == "control", j.vars],
  arc.rewet.inc.14c.sum[arc.rewet.inc.14c.sum$treat.bi != "control", j.vars],
  by = c(j.vars[1:3]),
  suffix = c(".ctl", ".trt"))


arc.rewet.14c.ctl.trt$d14c_dif <- arc.rewet.14c.ctl.trt$d14c_corr.ctl - arc.rewet.14c.ctl.trt$d14c_corr.trt
arc.rewet.14c.ctl.trt$c_dif <- arc.rewet.14c.ctl.trt$mgCO2.C_gC.ctl - arc.rewet.14c.ctl.trt$mgCO2.C_gC.trt

## Look at effect of c_dif by experiment and interaction with type
# air-dry + storage
summary(lm(d14c_dif ~ c_dif * Type, arc.rewet.14c.ctl.trt[arc.rewet.14c.ctl.trt$Experiment == "arc", ]))
# effect of c_dif on d14c_dif ns; interaction also ns

# rewet
summary(lm(d14c_dif ~ c_dif * Type, arc.rewet.14c.ctl.trt[arc.rewet.14c.ctl.trt$Experiment == "rewet", ]))
# effect of c_dif marginally significant (p = 0.0632)

# Look at effect of c_dif and interaction with type overall
summary(lm(d14c_dif ~ Type * c_dif * Experiment, arc.rewet.14c.ctl.trt))
# no significance of c_dif overall
rm(j.vars)
```

```{r plot-cdif-d14c, include = FALSE}
ggplot(arc.rewet.14c.ctl.trt, aes(c_dif, d14c_dif, color = Type, shape = Experiment)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_point(size = 3) +
  scale_color_manual(name = 'Land use',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  theme_bw() +
  theme(panel.grid = element_blank())
```

[maybe expand with stats for other explanatory factors? e.g. texture, N content, change in moisture upon rewetting, etc...]

We looked at the possible effect of the difference in the amount of carbon respired (mg CO~2~-C g soil C^-1^) on the differences between control and treatment ^14^C-CO~2~ using a linear regression model, but it was not significant overall. When data from Experiment 1 and Experiment 2 were considered separately, we observed a slight positive trend between the difference in respired carbon and the difference in ^14^C-CO~2~ within Experiment 2, but it was only marginally significant (p = `r {round(summary(lm(d14c_dif ~ c_dif * Type, arc.rewet.14c.ctl.trt[arc.rewet.14c.ctl.trt$Experiment == "rewet", ]))$coef[2,4],3)}`). 

```{r plot-14c-by-c-resp}
# 10. Plot $\Delta$^14^C against proportion of soil C respired by experiment, land cover, and sampling period.
# collapse treatment variable into binary control/treatment
all.14c.sum.df$treat.bi <- ifelse(all.14c.sum.df$Treatment == "control", "control", "treatment")

# HEW22 control pre point excluded to make figure more readable 
all.14c.sum.df %>%
  filter(Experiment != "tme") %>%
  mutate(ID.treat = paste(ID, Treatment)) %>%
  mutate(ID.treat.Period = paste(ID.treat, Period)) %>%
  filter(ID.treat.Period != "HEW22 control pre") %>%
  mutate(treat.Period = paste(treat.bi, Period)) %>%
  ggplot(., aes(mgCO2.C_gC_mean, d14c_corr_mean, color = Type, shape = treat.Period)) +
  geom_point(size = 3) +
  geom_path(aes(group = ID.treat)) +
  geom_errorbar(
    aes(ymin = d14c_corr_min, 
        ymax = d14c_corr_max, 
        color = Type), 
    width = .25) +
  geom_errorbarh(
    aes(xmin = mgCO2.C_gC_min, 
        xmax = mgCO2.C_gC_max, 
        color = Type), 
    height = .9) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Sampling period (treatment)',
                     values =c(16, 17, 1, 2),
                     labels = c("control pre" = 'pre-incubation\n(control)', 
                                "control inc" = 'equilibrium respiration\n(control)',
                                "treatment pre" = 'pre-incubation\n(air-dry/air-dry + storage)',
                                "treatment inc" = 'equilibrium respiration\n(air-dry/air-dry + storage)')) +
  facet_grid(cols = vars(Type), rows = vars(YearSampled)) +
  xlab(expression('Respired C (mgCO'[2]*'-C'*' g soil C'^-1*')')) +
  ylab(expression('mean '*Delta*''^14*'C (â€°)')) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.key.height=unit(.8, "cm"))
```

>**Supplementary Fig. `r {sfig.n + 1}`. Change in ^14^C-CO~2~ in relation to cumulative soil carbon respired**

>*Caption:* Note that pre-incubation $\Delta$^14^C was not measured for the 2011 control samples. Limits exclude outlier point (HEW22 control pre-incubation) for improved legibility. [Not planning to include this figure in the main text as I think it is difficult to interpret].

```{r plot C resp vs 14C averaged by land use and treatment, include = FALSE}
# Alternate C-resp x 14c fig: data averaged by land use and treatment within sampling periods
all.14c.sum2 %>%
  mutate(treat.Period = paste(treat.bi, Period)) %>%
  ggplot(., aes(mgCO2.C_gC_mean, d14c_corr_mean, color = Type, shape = treat.Period)) +
  geom_point(size = 3) +
  geom_path(aes(group = Treatment)) +
  geom_errorbar(
    aes(ymin = d14c_corr_u, 
        ymax = d14c_corr_l, 
        color = Type), 
    width = .25) +
  geom_errorbarh(
    aes(xmin = mgCO2.C_gC_u, 
        xmax = mgCO2.C_gC_l, 
        color = Type), 
    height = .9) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Sampling period (treatment)',
                     values =c(16, 17, 1, 2),
                     labels = c("control pre" = 'pre-incubation\n(control)', 
                                "control inc" = 'equilibrium respiration\n(control)',
                                "treatment pre" = 'pre-incubation\n(air-dry/air-dry + storage)',
                                "treatment inc" = 'equilibrium respiration\n(air-dry/air-dry + storage)')) +
  facet_grid(cols = vars(Type), rows = vars(YearSampled)) +
  xlab(expression('Respired C (mgCO'[2]*'-C'*' g soil C'^-1*')')) +
  ylab(expression('mean '*Delta*''^14*'C (â€°)')) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.key.height=unit(.8, "cm"))
```

```{r plot 14c by c resp with outlier, include = FALSE}
# Code for a third plot with outlier data
# average control and treatment data
all.14c.sum3 <- select(all.14c.ls[[2]], Type, Period, Treatment, Experiment, YearSampled, d14c_corr, mgCO2.C_gC) %>%
  group_by(Type, Period, Treatment, Experiment, YearSampled) %>%
  add_count() %>%
  summarize_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(d14c_corr_se = d14c_corr_sd/n_mean,
         d14c_corr_u = d14c_corr_mean + d14c_corr_se*2,
         d14c_corr_l = d14c_corr_mean - d14c_corr_se*2,
         mgCO2.C_gC_se = mgCO2.C_gC_sd/n_mean,
         mgCO2.C_gC_u = mgCO2.C_gC_mean + mgCO2.C_gC_se*2,
         mgCO2.C_gC_l = mgCO2.C_gC_mean - mgCO2.C_gC_se*2) 

all.14c.sum3$treat.bi <- ifelse(all.14c.sum3$Treatment == "control", "control","treatment")
all.14c.sum3 %>%
  mutate(treat.Period = paste(treat.bi, Period)) %>%
  ggplot(., aes(mgCO2.C_gC_mean, d14c_corr_mean, color = Type, shape = treat.Period)) +
  geom_point(size = 3) +
  geom_path(aes(group = Treatment)) +
  geom_errorbar(
    aes(ymin = d14c_corr_u, 
        ymax = d14c_corr_l, 
        color = Type), 
    width = .25) +
  geom_errorbarh(
    aes(xmin = mgCO2.C_gC_u, 
        xmax = mgCO2.C_gC_l, 
        color = Type), 
    height = .9) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Sampling period (treatment)',
                     values =c(16, 17, 1, 2),
                     labels = c("control pre" = 'pre-incubation\n(control)', 
                                "control inc" = 'equilibrium respiration\n(control)',
                                "treatment pre" = 'pre-incubation\n(air-dry/air-dry + storage)',
                                "treatment inc" = 'equilibrium respiration\n(air-dry/air-dry + storage)')) +
  facet_grid(cols = vars(Type), rows = vars(YearSampled)) +
  xlab(expression('Respired C (mgCO'[2]*'-C'*' g soil C'^-1*')')) +
  ylab(expression('mean '*Delta*''^14*'C (â€°)')) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.key.height=unit(.8, "cm"))
```

## Treatment effect on ^14^C-CO~2~ for all samples (Experiments 1, 2, and 3)

Difference between control and treatment samples from all experiments show that treatment effects, i.e. air-drying followed by rewetting or air-drying followed by storage and subsequent rewetting, typically result in changes in ^14^C-CO~2~ between Â±20â€° to Â±40â€°, with the majority within Â±20â€°. These difference are equivalent to the decline in atmospheric radiocarbon over 5 and 10 years, respectively, during the period of 2000 to 2020. The samples from Tennessee (magenta points) are an exception. However, these points do not show only bomb-C enrichment, but rather the results of exposure to a localized plume of ^14^C enriched CO~2~ from a nearby incinerator four years prior to sample collection (Trumbore et al., 2002). Treatment ^14^C-CO~2~ for these highly enriched samples were more depleted relative to the controls than were the samples only labeled with bomb-C.

Grassland samples tend to be above 1:1 line, while forest samples are generally below, regardless of origin. One exception to this trend is the three German forest samples that are above 1:1 line, which were analyzed in 2019 (air-dry only treatment).
```{r plot ctl vs trt}
# Filter data to "inc", split by binary treatment variable, then merge
all.14c.ctl <- all.14c.sum.df[all.14c.sum.df$treat.bi == "control" & all.14c.sum.df$Period == "inc", ]
all.14c.ctl <- rename_at(all.14c.ctl, vars(contains('d14c')), list(~paste0(., "_ctl")))
all.14c.trt <- all.14c.sum.df[all.14c.sum.df$treat.bi == "treatment" & all.14c.sum.df$Period == "inc", ]
all.14c.trt <- rename_at(all.14c.trt, vars(contains('d14c')), list(~paste0(., "_trt")))
all.14c.ctl.trt <- inner_join(data.frame(all.14c.ctl) %>% 
                                select(ID, Experiment, Type, Site, Horizon, contains("d14c_corr")),
                              data.frame(all.14c.trt) %>% 
                                select(ID, Experiment, Type, Site, Horizon, contains("d14c_corr")),
                              by = c("ID", "Experiment", "Type", "Site", "Horizon"))

# First add YearSampled and YearMeasured columns
all.14c.ctl.trt$YearSampled <- unlist(all.14c.sum.df[match(all.14c.ctl.trt$ID, all.14c.sum.df$ID), "YearSampled"])
# correct archive sample YearSampled
all.14c.ctl.trt[all.14c.ctl.trt$Experiment == "arc" & all.14c.ctl.trt$Site == "Hainich", "YearSampled"] <- 2011

# add year measured column, modify for tme.misc samples, rewet samples
all.14c.ctl.trt$YearMeasured <- 2018
all.14c.ctl.trt[all.14c.ctl.trt$Experiment == "rewet", "YearMeasured"] <- 2019
all.14c.ctl.trt[which(all.14c.ctl.trt$ID %in% tme.misc$ID), "YearMeasured"] <- 2009

# calculate storage duration numerically and as factor
all.14c.ctl.trt$tme <- unlist(all.14c.ctl.trt$YearMeasured - all.14c.ctl.trt$YearSampled)
all.14c.ctl.trt$tme.f <- factor(all.14c.ctl.trt$tme)

# add difference column
# (expressed as difference of means)
all.14c.ctl.trt$ctl.trt.d14 <- all.14c.ctl.trt$d14c_corr_mean_ctl - all.14c.ctl.trt$d14c_corr_mean_trt
# trt-ctl makes Fig. 4 (1:1 line) and Fig. 5 (storage duration) more compatible
all.14c.ctl.trt$trt.ctl.d14 <- all.14c.ctl.trt$d14c_corr_mean_trt - all.14c.ctl.trt$d14c_corr_mean_ctl

# list of locations for recoding
loc <- list(
    "Duke" = "Duke, NC",
    "Howland" = "Howland, ME",
    "Harvard" = "Harvard, MA",
    "Hainich" = "Central Germany",
    "Schorfheide" = "Central Germany",
    "Musick" = "Sierra Nevada, CA",
    "Shaver" = "Sierra Nevada, CA",
    "Walker Branch" = "Oak Ridge, TN",
    "Tennessee Valley" = "Oak Ridge, TN")

# # add atm 14C for year sampled and calculate delta-delta
# all.14c.ctl.trt$atm.yr.sampled <- Datm[match(all.14c.ctl.trt$YearSampled, floor(Datm$Date)), "NHc14"]
# all.14c.ctl.trt$dd.ctl <- all.14c.ctl.trt$d14c_corr_mean_ctl - all.14c.ctl.trt$atm.yr.sampled
# all.14c.ctl.trt$dd.trt <- all.14c.ctl.trt$d14c_corr_mean_trt - all.14c.ctl.trt$atm.yr.sampled
# all.14c.ctl.trt$ctl.trt.dd14 <- all.14c.ctl.trt$dd.ctl - all.14c.ctl.trt$dd.trt
# Plot on 1:1 line w/ diagonal lines showing â€° offsets
# first collapse sites for better visuals
all.14c.ctl.trt %>%
  filter(Horizon == "A") %>%
  mutate(Location = recode(Site, !!!loc)) %>%
  ggplot(., aes(d14c_corr_mean_ctl, d14c_corr_mean_trt, color = Location, shape = Type)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_abline(slope = 1, intercept = -20, linetype = "dashed") +
  geom_abline(slope = 1, intercept = 20, linetype = "dashed") +
  geom_abline(slope = 1, intercept = -40, linetype = "dotted") +
  geom_abline(slope = 1, intercept = 40, linetype = "dotted") +
  geom_vline(xintercept = 0, color = "gray") +
  geom_hline(yintercept = 0, color = "gray") +
  geom_point(size = 3) +
  geom_errorbar(
    aes(ymin = d14c_corr_min_trt, 
        ymax = d14c_corr_max_trt, 
        color = Location), 
    width = .25) +
  geom_errorbarh(
    aes(xmin = d14c_corr_min_ctl, 
        xmax = d14c_corr_max_ctl, 
        color = Location), 
    height = .9) +
  scale_color_manual(values = c('Duke, NC' = '#01BB97',
                                'Sierra Nevada, CA' = '#FFC107',
                                'Central Germany' = 'black',
                                'Harvard, MA' = '#1E88E5',
                                'Oak Ridge, TN' = '#D81B60')) +
  scale_shape_manual(name = 'Land use',
                     values = c('F'= 17,'G' = 16),
                     labels = c('Forest','Grassland')) +
  xlab(expression('Control '*Delta*''^14*'C (â€°)')) +
  ylab(expression('Treatment '*Delta*''^14*'C (â€°)')) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.key.height=unit(.8, "cm"),
        aspect.ratio = 1)

# for plotting with color = Type (currently suppressed)
# all.14c.ctl.trt %>%
#   filter(Horizon == "A") %>%
#   mutate(Location = factor(recode(Site, !!!loc), exclude = TRUE)) %>%
#   ggplot(., aes(d14c_corr_mean_ctl, d14c_corr_mean_trt, color = Type, shape = Location)) +
#   geom_abline(slope = 1, intercept = 0) +
#   geom_abline(slope = 1, intercept = -20, linetype = "dashed") +
#   geom_abline(slope = 1, intercept = 20, linetype = "dashed") +
#   geom_abline(slope = 1, intercept = -40, linetype = "dotdash") +
#   geom_abline(slope = 1, intercept = 40, linetype = "dotdash") +
#   geom_vline(xintercept = 0, color = "gray") +
#   geom_hline(yintercept = 0, color = "gray") +
#   geom_point(size = 3) +
#   geom_errorbar(
#     aes(ymin = d14c_corr_min_trt, 
#         ymax = d14c_corr_max_trt, 
#         color = Type), 
#     width = .25) +
#   geom_errorbarh(
#     aes(xmin = d14c_corr_min_ctl, 
#         xmax = d14c_corr_max_ctl, 
#         color = Type), 
#     height = .9) +
#   scale_color_manual(name = 'Land use',
#                      values =c('F'='#a35513','G'='#1361a3'),
#                      labels = c('Forest','Grassland')) +
#   xlab(expression('Control '*Delta*''^14*'C (â€°)')) +
#   ylab(expression('Treatment '*Delta*''^14*'C (â€°)')) +
#   theme_bw() +
#   theme(panel.grid = element_blank(),
#         legend.key.height=unit(.8, "cm"),
#         aspect.ratio = 1)
```
>**Fig. `r {fig.n + 4}`. Effect of air-drying and rewetting + storage on ^14^C-CO~2~**

>*Caption:* Points show data from all three experiments. Points are the mean of laboratory replicates (for replicated samples); error bars are 2x standard error of the mean. Solid line is 1:1, while the dashed and dotted lines show differences of Â±20â€° and Â±$40â€°, equivalent to the decline in atmospheric CO~2~ over 5 and 10 years respectively during the period of 2000 to 2020.

## Storage duration effect on ^14^C-CO~2~ (Experiment 3)

There does not seem to be evidence for a storage duration effect in the samples that only contain bomb-C, although the trend in the differences due to treatment for the highly enriched samples from Oak Ridge, TN suggest losses of the most recently fixed carbon over the duration of storage. These samples were included primarily because it was assumed that they would be more sensitive to potential losses of recently fixed carbon, as the label should only be present in this pool of soil C. 
```{r plot-dur-stor}
# Plot storage duration
suppressWarnings(
  all.14c.ctl.trt %>%
  filter(Horizon == "A") %>%
  filter(Experiment != "rewet") %>%
  select(Type, tme.f, Site, trt.ctl.d14, tme) %>%
  group_by(Type, tme.f, Site) %>%
  add_tally() %>%
  summarise_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(dif_se = trt.ctl.d14_sd/n_mean,
         dif_u = trt.ctl.d14_mean + dif_se*2,
         dif_l = trt.ctl.d14_mean - dif_se*2) %>%
  mutate(Location = factor(recode(Site, !!!loc), exclude = TRUE)) %>%
  ggplot(., aes(tme_mean, trt.ctl.d14_mean, color = Location, shape = Type)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = -20, linetype = "dashed") +
  geom_hline(yintercept = 20, linetype = "dashed") +
  geom_hline(yintercept = 40, linetype = "dotted") +
  geom_hline(yintercept = -40, linetype = "dotted") +
  geom_point(size = 3, position = position_dodge2(width = .7, preserve = "single")) +
  geom_errorbar(
    aes(ymin = dif_l,
        ymax = dif_u, 
        color = Location),
    width = .7,
    position = position_dodge2(width = .7, preserve = "single")) +
  scale_color_manual(values = c('Duke, NC' = '#01BB97',
                                'Sierra Nevada, CA' = '#FFC107',
                                'Central Germany' = 'black',
                                'Harvard, MA' = '#1E88E5',
                                'Oak Ridge, TN' = '#D81B60')) +
  scale_shape_manual(name = 'Land use',
                     values = c('F'= 17,'G' = 16),
                     labels = c('Forest','Grassland')) +
  scale_x_continuous(breaks = seq(5,13,2)) +
  ylab(expression('Treatment - Control '*Delta*''^14*'C (â€°)')) +
  xlab("Storage duration (years)") +
  theme_bw() +
  theme(panel.grid = element_blank())
  )
```

>**Fig. `r {fig.n + 5}`. Change in ^14^C-CO~2~ in relation to storage duration**

>*Caption:* Points show data from both Experiment 1 (in black) and Experiment 3 (all other points). Dashed and dotted lines show a difference of 20â€° and 40â€°, equivalent to the atmospheric decline over five and 10 years respectively for the period 2000 to 2020. Position of points jittered to avoid overplotting; storage duration has been rounded down to the nearest whole year.

The trend in the differences due to treatment for the highly enriched samples from Oak Ridge, TN suggest losses of the most recently fixed carbon over the duration of storage. The TN samples were included primarily because it was assumed that they would be more sensitive to potential losses of recently fixed carbon, as the label should only be present in this pool of soil C. However, in contrast, there does not seem to be evidence for a storage duration effect in the samples that only contain bomb-C.


# Discussion

*Random notes here...*

*Effect of C respired*
```{r som-14c-calcs, include = FALSE}
# read 14C SOM data
exp.som14c <- read.xlsx("../data/external/exploratories_ischoening_14c-som_2011/170228_14C_SOM.xlsx")
exp.som14c %>% 
  filter(Exploratory != "A") %>%
  group_by(Exploratory, Type) %>%
  summarize(mean = mean(`14C_SOM`))
```


What is the effect of 13C? Can we explain the patterns in 14C or the differences between grasslands and forests with 13C data?

Note that 13C can give insight into the type of compound, as well as the degree of processing, cf. Buzek et al 2009. Oxidation of microbial CH~4~ to CO~2~ can lead to extremely negative $\delta$^13^C. CO~2~ derived from unprocessed material should have $\delta$^13^C values closer to that of plants, while highly processed material would be heavier.


```{r stats-13c}

```

# Within rep variability

Compare the variability in $\Delta$^14^C among laboratory replicates to that between treatment and control.

Calculate by site, by ecosystem. Note that means and standard errors for the Experiment 2 samples ("rewet") are calculated as the mean of the mean differences observed for control duplicates and for treatment duplicates, and the standard error is equal to the square root of the sum of the variances for each set.

```{r rep-var}
# calc difference between reps and compare to dif between ctl and treat
e12.d14 <- all.14c.ls[[2]]
e12.d14.inc <- e12.d14[e12.d14$Period == "inc", ]

# calculate dd14c
dd14c.sum <- e12.d14.inc
dd14c.sum$atm14c <- ifelse(dd14c.sum$YearSampled == 2011,
                             Datm[which(Datm$Date == 2011.5), "NHc14"],
                             Datm[which(Datm$Date == 2019.5), "NHc14"])
dd14c.sum$dd14c <- dd14c.sum$d14c_corr - dd14c.sum$atm14c
dd14c.sum <- dd14c.sum %>% 
  select(Experiment, Treatment, Type, dd14c) %>%
  group_by(Experiment, Treatment, Type) %>%
  add_tally() %>%
  summarize_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(dd14c_se = dd14c_sd/n_mean)

dd14c.sum %>%
  mutate(treat.bi = ifelse(Treatment != "control", "treatment", "control"),
         dd14c_min = dd14c_mean - dd14c_se*2,
         dd14c_max = dd14c_mean + dd14c_se*2) %>%
  ggplot(., aes(Experiment, dd14c_mean, color = Type)) +
  geom_point(size = 3) +
  geom_errorbar(
    aes(ymin = dd14c_min, 
        ymax = dd14c_max, 
        color = Type), 
    width = .1) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  facet_grid(cols = vars(treat.bi)) + 
  theme_bw() +
  theme(panel.grid.minor = element_blank())

# split by Experiment and Type to compare with ctl-trt difs
e12.d14.inc.ls <- lapply(split(e12.d14.inc, e12.d14.inc$Experiment), function(x) {
    lapply(split(x, x$Type), function(y) {
      y <- lapply(split(y, y$Treatment), function(z) {
        z <- lapply(split(z, z$ID), function(m) {
          if(nrow(m) > 1) {
            m <- abs(m[2, "d14c"] - m[1, "d14c"])
          } else {
            m <- NA
          }
        })
        mean <- mean(unlist(z))
        sd <- sd(unlist(z))
        var <- var(unlist(z))
        n <- length(z)
        z.ls <- list(mean = mean,
                     sd = sd,
                     var = var,
                     n = n,
                     se = sd/sqrt(n))
        })
  })
})

# reduce list
var.names <- c("Experiment", "Type", "Treatment", "dispersion")
values <- unlist(e12.d14.inc.ls)
e12.d14.sdif.mat <- matrix(ncol = length(var.names) + 1, 
                           nrow = length(values),
                           dimnames = list(NULL, c(var.names, "value")))
for(i in seq_along(var.names)) {
  e12.d14.sdif.mat[, i] <- unlist(lapply(strsplit(names(values), "\\."), "[[", i))
}

e12.d14.sdif <- data.frame(e12.d14.sdif.mat)
e12.d14.sdif$value <- values
 
# widen and remove NAs
e12.d14.sdif <- pivot_wider(e12.d14.sdif,
                            names_from = "dispersion",
                            values_from = "value")
e12.d14.sdif <- e12.d14.sdif[!is.na(e12.d14.sdif$mean), ]

# make further reduced df (collapse treatment)
e12.d14.sdif2 <- data.frame(Experiment = rep(c("arc", "rewet"), each = 2),
                            Type = rep(c("F", "G"), 2))
e12.d14.sdif2$mean <- unlist(c(e12.d14.sdif[e12.d14.sdif$Experiment == "arc" &e12.d14.sdif$Type == "F", "mean"],
                        e12.d14.sdif[e12.d14.sdif$Experiment == "arc" &e12.d14.sdif$Type == "G", "mean"],
                        mean(unlist(e12.d14.sdif[e12.d14.sdif$Experiment == "rewet" &e12.d14.sdif$Type == "F", "mean"])),
                        mean(unlist(e12.d14.sdif[e12.d14.sdif$Experiment == "rewet" &e12.d14.sdif$Type == "G", "mean"]))))

# function for calculating std err of difs
std.err.dif <- function(sds, ns) {sqrt(sds[1]^2/ns[1] + sds[2]^2/ns[2])}
# function for calculating mean std dev
std.dev.mean <- function(vars) {sqrt(mean(vars))}

e12.d14.sdif2$se <- unlist(c(e12.d14.sdif[e12.d14.sdif$Experiment == "arc" &e12.d14.sdif$Type == "F", "se"],
                        e12.d14.sdif[e12.d14.sdif$Experiment == "arc" &e12.d14.sdif$Type == "G", "se"],
                      std.err.dif(unlist(e12.d14.sdif[e12.d14.sdif$Experiment == "rewet" &e12.d14.sdif$Type == "F", "sd"]),
                                  unlist(e12.d14.sdif[e12.d14.sdif$Experiment == "rewet" &e12.d14.sdif$Type == "F", "n"])),
                      std.err.dif(unlist(e12.d14.sdif[e12.d14.sdif$Experiment == "rewet" &e12.d14.sdif$Type == "G", "sd"]),
                                  unlist(e12.d14.sdif[e12.d14.sdif$Experiment == "rewet" &e12.d14.sdif$Type == "G", "n"]))))

# calc mean variance
e12.d14.sdif2$var <- unlist(c(e12.d14.sdif[e12.d14.sdif$Experiment == "arc" &e12.d14.sdif$Type == "F", "var"],
                        e12.d14.sdif[e12.d14.sdif$Experiment == "arc" &e12.d14.sdif$Type == "G", "var"],
                      mean(unlist(e12.d14.sdif[e12.d14.sdif$Experiment == "rewet" &e12.d14.sdif$Type == "F", "var"])),
                      mean(unlist(e12.d14.sdif[e12.d14.sdif$Experiment == "rewet" &e12.d14.sdif$Type == "G", "var"]))))

# mean std dev for forests
std.dev.mean(c(e12.d14.sdif2[e12.d14.sdif2$Type == "F", "var"]))
# mean std dev for grasslands
std.dev.mean(c(e12.d14.sdif2[e12.d14.sdif2$Type == "G", "var"]))

# compare to ctl treat dif
e12.14c.ctl.trt <- all.14c.ctl.trt %>%
  select(Experiment, Type, ctl.trt.d14) %>%
  group_by(Experiment, Type) %>%
  add_tally() %>%
  summarize_all(list(mean = mean, sd = sd, var = var), na.rm = TRUE) %>%
  mutate(ctl.trt.se = ctl.trt.d14_sd/n_mean)

# combine
var.cf <- cbind.data.frame(e12.14c.ctl.trt[1:4, ], e12.d14.sdif2[ , c("mean", "se")])
knitr::kable(var.cf[, c("Experiment", "Type", "ctl.trt.d14_mean", "ctl.trt.se", "mean", "se")],
             col.names = c("Experiment", "Type", "Ctl-Trt mean dif", "Ctl-Trt SE", "Replicate mean dif", "Replicate SE"),
             caption = "Comparison of treatment differences versus variability among replicates",
             align = "c",
             digits = 1)
```

# Change in soil moisture content with moisture adjustment

The main treatment effect in all three experiments is the degree of moisture adjustment of the soil sample prior to incubation. In the case of the control samples the change in moisture content is less extreme than the treatment samples since the samples are still field-moist rather than air-dried. The magnitude of the treatment effect may therefore depend on what the field moisture content of the control soils was.

```{r delta-moisture-calc}
# compare the change in moisture with control samples versus treatment samples
whcFresh <- merge(archive.ctl.ts.wide[archive.ctl.ts.wide$Experiment == "arc", c("ID", "whcFresh")],
                  jarinfo.rewet[jarinfo.rewet$Treatment == "control", c("ID", "whcFresh")],
                  by = "ID",
                  all.x = TRUE,
                  suffixes = c("_2011", "_2019"))
whcFresh$deltaWHC_2011 <- .6-whcFresh$whcFresh_2011
whcFresh$deltaWHC_2019 <- .6-whcFresh$whcFresh_2019
whcFresh$Type <- ifelse(grepl("G", whcFresh$ID), "G", "F")

# sumamrize
whcFresh_sum <- whcFresh %>%
  select(Type, deltaWHC_2011, deltaWHC_2019) %>%
  group_by(Type) %>%
  add_tally() %>%
  summarize_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(se_11 = deltaWHC_2011_sd/n_mean,
         se_19 = deltaWHC_2019_sd/n_mean)
```

