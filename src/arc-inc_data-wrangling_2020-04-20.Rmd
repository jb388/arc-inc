---
title: "Archived Soil Incubations Project"
author: "J. Beem-Miller"
date: "21 Apr 2020"
header_includes:
- \usepackage{textcomp}
output:
  pdf_document:
    latex_engine: xelatex
  html_document:
    df_print: paged
  html_notebook: default
---
```{r global_options, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = 'center')
```

```{r setup, include = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(SoilR)
library(corrplot)
library(openxlsx)
library(ISRaD)
```
# Notes:
* This workbook is intended to load and prepare the key data for analysis for the archive incubation project.
* in general, this is an updated version of script "./src/arc_inc_master.R"
* all code chunk options are set to "echo = FALSE"; see raw .Rmd file for data wrangling code.

# CO~2~ fluxes and soil data 
1. Load flux data from air-dry + storage control samples, and convert from "wide" to "long" format so as to match other data.
```{r read wide ts data}
# Read air-dry + storage respiration control data
archive.ctl.ts.wide <- read.csv("../data/derived/arc-storage-t1-flux/arc-inc_xplr_arc-storage-t1-flux_2020-04-20.csv")

# Convert time data from wide to long
archive.ctl.ts.d <- select(archive.ctl.ts.wide, starts_with("inc_time_d")) %>%
  pivot_longer(everything(),
               names_to = "timepoint_cmtv",
               names_prefix = "inc_time_d_",
               values_to = "time_d")
# sort by timepoint_cmtv
archive.ctl.ts.d <- data.frame(archive.ctl.ts.d[order(archive.ctl.ts.d$timepoint_cmtv),])

# Convert mgCO2 data from wide to long
archive.ctl.ts.co2 <- select(archive.ctl.ts.wide, starts_with("inc_mgCO2_jar_")) %>%
  pivot_longer(everything(),
               names_to = "timepoint_cmtv",
               names_prefix = "inc_mgCO2_jar_",
               values_to = "mgCO2_jar")
# sort by timepoint_cmtv
archive.ctl.ts.co2 <- archive.ctl.ts.co2[order(archive.ctl.ts.co2$timepoint_cmtv),]

# assemble in long dataframe 
archive.ctl.ts <- data.frame(ID = rep(unique(archive.ctl.ts.wide$ID), 4),
                             Period = "inc",
                             timepoint_cmtv = rep(seq(from = 2, 
                                                      to = 5), 
                                                  each = length(archive.ctl.ts.wide$ID)),
                             time_d = archive.ctl.ts.d$time_d,
                             mgCO2_jar = archive.ctl.ts.co2$mgCO2_jar)

# add preincubation data
archive.ctl.ts.pre <- archive.ctl.ts.wide[1:length(unique(archive.ctl.ts.wide$ID)),
                                          c("ID", "preinc_time_d", "preinc_mgCO2_jar")]
archive.ctl.ts.pre <- rename(archive.ctl.ts.pre, time_d = preinc_time_d, mgCO2_jar = preinc_mgCO2_jar)
archive.ctl.ts.pre$timepoint_cmtv <- 1
archive.ctl.ts.pre$Period <- "pre"
archive.ctl.ts.pre$time_d_cmtv <- archive.ctl.ts.pre$time_d
  
# Calculate time_d_cmtv
archive.ctl.ts <- bind_rows(
  lapply(
    split(archive.ctl.ts, archive.ctl.ts$timepoint_cmtv),
    function(x) {
      x$time_d_cmtv <- x$time_d + 
        archive.ctl.ts.pre[match(x$ID, archive.ctl.ts.pre$ID), "time_d"]
      return(x)
    }
    )
  )

# rbind preinc and inc data
archive.ctl.ts <- rbind(archive.ctl.ts.pre, archive.ctl.ts)

# add SampleName column
archive.ctl.ts$SampleName <- archive.ctl.ts$ID

# remove intermediate files
rm(archive.ctl.ts.d, archive.ctl.ts.co2, archive.ctl.ts.pre)
```

2. Load flux data from air-dry + storage samples and from air-dry experiment (ctl & treatment), C & N data for all the Exploratories samples (measured in 2011), and soil mass and moisture data for all experiments.
```{r read long ts data}
# Read Xplr C and N data
xplr.cn <- read.csv("../data/external/exploratories_ischoening_soilcn_2011/170407_CN_concentrations_Exploratories_EP_Plots_2011.csv")

# Read soil mass and moisture info for air-dry + storage data
jarinfo.arc <- read.csv("../data/derived/arc-storage-t2-jarInfo/jar_information.csv")

# Read soil mass and moisture info for air-dry data
jarinfo.rewet <- read.csv("../data/derived/air-dry-2019-whc/air-dry-2019-whc_2020-04-21.csv")

# Read air-dry + storage respiration data
archive.arc.ts <- read.csv("../data/derived/arc-storage-t2-flux/archive-flux-t2_2020-04-24.csv")

# Read control respiration data from 2019 air-dry experiment
rewet.ctl.ts <- read.csv("../data/derived/fresh-2019-flux/fresh-2019-flux_2020-04-24.csv")

# Read treatment respiration data from 2019 air-dry experiment
rewet.dry.ts <- read.csv("../data/derived/dried-2019-flux/dried-2019-flux_2020-04-24.csv")
```

3. Combine and summarize data in long format to calculate respiration rates and plot over time.
```{r summarize data, include = FALSE}
# NB: set "include" to false to suppress bind_rows warning about coercing factor to char
# remove formula_check columns
invisible(list2env(lapply(list(archive.arc.ts = archive.arc.ts, 
                               rewet.ctl.ts = rewet.ctl.ts, 
                               rewet.dry.ts = rewet.dry.ts
                               ),
                          function(x) {
                            x$formula_check <- NULL
                            return(x)
                            }),
                   envir = .GlobalEnv)
          )

# Add Treatment columns to each dataset
archive.arc.ts$Treatment <- "air-dry + storage (2011)"
archive.ctl.ts$Treatment <- "control (2011)"
rewet.ctl.ts$Treatment <- "control (2019)"
rewet.dry.ts$Treatment <- "air-dry (2019)"

# combine rewet data
rewet.ts <- rbind(rewet.ctl.ts, rewet.dry.ts)
rewet.ts$Experiment <- "2019"

# add soil dry wt data
archive.arc.ts$dw_g <- jarinfo.arc[match(archive.arc.ts$SampleName, jarinfo.arc$Sample), "Soil.dry.weight_.g."]
archive.ctl.ts$dw_g <- archive.ctl.ts.wide[match(archive.ctl.ts$ID, archive.ctl.ts.wide$ID), "dry_soil_wt_corrected_g"]
rewet.ts <- merge(rewet.ts, jarinfo.rewet[ , c("ID", "Treatment", "dw_g")], by = c("ID", "Treatment"))

# combine archive data
archive.ts <- rbind(archive.ctl.ts, 
                    archive.arc.ts[ , names(archive.ctl.ts)])
archive.ts$Experiment <- "2011"

# Test that required names are present
nms <- c("SampleName", "ID", "Experiment", "Treatment", "Period", "timepoint_cmtv",  "time_d", "time_d_cmtv", "mgCO2_jar", "dw_g")
invisible(lapply(list(archive.ts = archive.ts,
                      rewet.ts = rewet.ts),
       function(x) {
         ifelse(!is.na(match(nms, names(x))), "yes", "no")
       }
       ))

# combine all data
ts <- bind_rows(archive.ts[ , nms], rewet.ts[ , nms])

# add C content and Type column
ts$gC_gS <- xplr.cn[match(ts$ID, xplr.cn$EP_Plotid), "Total_C"]*10^-3
ts$Type <- ifelse(grepl("G", ts$ID), "G", "F")

# calculate CO2 respiration in mgCO2-C per g soil C
# NB: 12/44 = mass ratio of C in CO2
ts$mgCO2.C_gC <- (ts$mgCO2_jar*(12/44))/(ts$dw_g*ts$gC_gS)
ts$mgCO2.C_gC_d <- ts$mgCO2.C_gC/ts$time_d

# summarize CO2 release data for each timepoint, by experiment, treatment, and type
# for some reason n() doesn't work when included with the summarize_all syntax, so done separately
ts.avg <- na.omit(ts) %>%
  select(Experiment, Treatment, Type, timepoint_cmtv, mgCO2.C_gC_d, time_d_cmtv)  %>%
  group_by(Experiment, Treatment, Type, timepoint_cmtv) %>%
  add_tally() %>%
  summarise_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(se_slope = mgCO2.C_gC_d_sd/sqrt(n_mean),
         se_slope_l = mgCO2.C_gC_d_mean - se_slope,
         se_slope_u = mgCO2.C_gC_d_mean + se_slope)

# add timepoint zero data
tp0.f <- function(df) {
  tp0 <- df[1, ]
  tp0[ , -which(names(tp0) == "Experiment" | names(tp0) == "Treatment" | names(tp0) == "Type" | names(tp0) == "n")] <- 0
  rbind(tp0, df)
}
ts.avg <- lapply(split(ts.avg, ts.avg$Treatment), function(x) {
  lapply(split(x, x$Type), tp0.f)
  })
ts.avg <- bind_rows(lapply(ts.avg, bind_rows))

# restore classes
ts.avg <- as.data.frame(lapply(ts.avg, type.convert))
```

4. Plot of CO~2~ fluxes over time. Note that the final measurement points for a few samples which took >18 days to reach CO~2~ targets are excluded for display reasons. Respiration rates for those samples remained flat.
```{r CO2 fluxes plots}
ggplot(ts.avg, aes(time_d_cmtv_mean, mgCO2.C_gC_d_mean)) +
  geom_vline(xintercept = 4, color="gray") +
  geom_ribbon(aes(ymin = se_slope_l, ymax = se_slope_u, fill = Type, linetype = Treatment, alpha = Treatment)) +
  geom_line(aes(color = Type, linetype = Treatment)) +
  facet_grid(rows = vars(Experiment)) +
  scale_x_continuous(limits = c(0,18)) +
  # scale_y_continuous(limits = c(0,30)) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_fill_manual(name = 'Std. Err.',
                    values =c('F'='#a35513','G'='#1361a3'),
                    labels = c('Forest','Grassland')) +
  scale_alpha_manual(name = 'Treatment',
                     values = c("air-dry + storage (2011)" = .2, 
                                "control (2011)" = .4,
                                "air-dry (2019)" = .2,
                                "control (2019)" = .4)) +
  scale_linetype_manual(name = 'Treatment',
                        values = c("air-dry + storage (2011)" = 'dashed', 
                                   "control (2011)" ='solid',
                                   "air-dry (2019)" = "dashed",
                                   "control (2019)" = "solid")) +
  ylab(expression('Respiration Rate (mgCO'[2]*'-C gC'^-1*'d'^-1*')')) +
  xlab("Time (days)") +
  theme_bw() +
  theme(panel.grid = element_blank())
```

# Isotope data

1. Read in isotope data from various sources. First load helper function 'read_jena_ams_results.R"
```{r load ams-jena-ingest fx}
source("./utilities/jena_ams_ingest.R")
```


2. Next read in data from the appropriate directories in 'data/raw'.
```{r read iso data}
# identify subdirectories in 'raw' directory with "ams_jena" in name
ams_jena_results_dirs <- list.files("../data/raw", pattern = "ams_jena_results", full.names = TRUE)
ams_results_ls <- lapply(seq_along(ams_jena_results_dirs), function(i) {
  read_jena_ams_results(ams_jena_results_dirs[i])
})
names(ams_results_ls) <- list.files("../data/raw", pattern = "ams_jena_results")
```


3. Create a "tidy" style template for the data, i.e. variables in columns. 
* Key variables are as follows:
  * SampleName (incorporates lab rep and treatment, e.g. "HEG10-1_dry")
  * ID (plot IDs, e.g. for "HEG10" for Exploratory samples)
  * Treatment (3 treatments: air-dry, air-dry + storage, storage duration; + controls)
  * Type (2 levels: F = forest, G = grassland)
  * Period (incubation period, 2 levels: pre = preincubation, inc = equilibrium incubation)
  * Experiment (3 levels: arc = air-dry + storage, rewet = air-dry/rewet, time = storage duration)

* Observational columns include:
  * d14c ($\Delta$^14^C-CO~2~)
  * d13c ($\delta$^13^C-CO~2~)
  * C_g_kg (C content)
  * dw_g (dry weight)
  * mgCO2.C_gS (mg CO~2~-C respired g^-1^ soil Period^-1^)
  * time_d (days in incubation period prior to measurement)
  * h2o_grav (gravimetric water content, percent)
  * h2o_whc_field (percent of water holding capacity, field-moist)
  
```{r non-timeseries data template}
unique.id.n <- c(length(unique(archive.ctl.ts$ID)),
                 length(unique(archive.arc.ts$SampleName)),
                 length(unique(rewet.ctl.ts$SampleName)),
                 length(unique(rewet.dry.ts$SampleName)))
pre.14c <- data.frame(SampleName = c(as.character(unique(archive.ctl.ts$ID)),
                                     as.character(unique(archive.arc.ts$SampleName)),
                                     as.character(unique(rewet.ctl.ts$SampleName)),
                                     as.character(unique(rewet.dry.ts$SampleName))))
pre.14c$ID <- substr(pre.14c$SampleName, 1, 5)
pre.14c$Type <- ifelse(grepl("G", pre.14c$ID), "G", "F")
pre.14c$Experiment <- c(rep("arc", unique.id.n[1] + unique.id.n[2]),
                       rep("rewet", unique.id.n[3] + unique.id.n[4]))
pre.14c$Treatment <- c(rep("control", unique.id.n[1]),
                       rep("air-dry + storage", unique.id.n[2]),
                       rep("control", unique.id.n[3]),
                       rep("air-dry", unique.id.n[4]))
pre.14c$Period <- "pre"

# create inc period df as duplicate of pre-inc df, but test that it is the right shape first
if(nrow(pre.14c) == sum(unique.id.n) & ncol(pre.14c) == 6) {
  inc.14c <- pre.14c
  inc.14c$Period <- "inc"
} else {
  "pre.14c data frame malformed"
}
all.14c.template <- rbind(pre.14c, inc.14c)
```


4. Summarize observational data from timeseries data by unique IDs (SampleName).
```{r combine soil obs data}
# summarize time and co2 data by experiment, period, and sample name
ts.epsn.avg <- na.omit(ts) %>%
  select(Period, SampleName, gC_gS, dw_g, mgCO2.C_gC, time_d, time_d_cmtv)  %>%
  group_by(Period, SampleName) %>%
  summarise_all(list(max = max))
ts.epsn.avg <- rename_at(ts.epsn.avg, vars(contains('max')), list(~sub("_max", "", .)))
```

5. Create helper functions for decay correction, converting $\Delta$^14^C to fraction modern, and cleaning up extraneous values in raw ^14^C data. Archived sample $\Delta$^14^C data should to be corrected for decay since the year of collection. (Although the correction is very small and likely insignificant, I will do it anyway).
* decay correction formula is:
$$1000 \cdot \left( (FM \cdot e^{\frac{-year_{sampled} + 1950}{8267}}) - 1 \right)$$
```{r 14C helper fxs}
# create decay correction function
decay.corr.fx <- function(year_sampled, fraction_modern) {
  ifelse(is.na(fraction_modern), NA, 1000*((fraction_modern*exp((-year_sampled + 1950)/8267))-1))
}

# d14C to fraction modern function
d14c.fm.fx <- function(year_sampled, d14c) {
  ((d14c / 1000) + 1) / exp(0.00012097 * (1950 - year_sampled))
  }

# define helper function for stripping out "NA" and non-Exploratories data
extra.clean.fx <- function(df) {
  df <- df[which(grepl("HEG", df$Probe) |
                   grepl("HEW", df$Probe) |
                   grepl("SEG", df$Probe) |
                   grepl("SEW", df$Probe)), ]
  ix <- which(is.na(df$F14C) & is.na(df$`∆14C.(‰)`))
  if(length(ix) > 1) {
    df <- df[-ix, ]
  }
  return(df)
}
```

6. Clean up ^14^C data.
```{r clean up 14C data}
# First add 14C and 13C data from arc control samples to ams_results_ls
# Also need to add SampleName col and variable columns Treatment, Period, and Experiment to all data frames in ams_results_ls 
# note that neither 13C nor 14C was measured for the pre-incubation period for these samples
arc.ctl.iso <- read.xlsx("../data/external/exploratories_ischoening_14c-co2_2011/170228_14C_Respiration.xlsx")
# add to ams_results_ls
results.14c.nms <- names(ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`)
arc_ctl_inc_SN <- as.character(all.14c.template[all.14c.template$Experiment == "arc" & all.14c.template$Treatment == "control" & all.14c.template$Period == "inc", "SampleName"])
ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc <- data.frame(matrix(nrow = length(arc_ctl_inc_SN), ncol = length(results.14c.nms))) 
names(ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc) <- results.14c.nms
ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc$SampleName <- arc_ctl_inc_SN
ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc$Probe <- arc_ctl_inc_SN
ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc$`∆14C.(‰)` <- arc.ctl.iso[match(ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc$SampleName, arc.ctl.iso$EP_Plotid), "14c_CO2"]
ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc$Treatment <- "control"
ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc$Experiment <- "arc"
ams_results_ls$exploratories_ischoening_14c.co2_2011$arc_ctl_inc$Period <- "inc"

# `ams_jena_results-co2_2019-01-28`
# `Beem-Miller_9.xlsx`
# Probe == SampleName
ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`$SampleName <- ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`$Probe
ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`$Treatment <- "air-dry + storage"
ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`$Period <- "pre"
ams_results_ls$`ams_jena_results-co2_2019-01-28`$`Beem-Miller_9.xlsx`$Experiment <- "arc"

# ams_results_ls$`ams_jena_results-co2_2019-02-25`$
# Archived_Incubations_30.xlsx
# Experiment = arc
# Treatment = air-dry + storage
# Period = inc
ams_results_ls$`ams_jena_results-co2_2019-02-25`$Archived_Incubations_30.xlsx$SampleName <- substr(ams_results_ls$`ams_jena_results-co2_2019-02-25`$Archived_Incubations_30.xlsx$Probe, 1, 9)
ams_results_ls$`ams_jena_results-co2_2019-02-25`$Archived_Incubations_30.xlsx$Treatment <- "air-dry + storage"
ams_results_ls$`ams_jena_results-co2_2019-02-25`$Archived_Incubations_30.xlsx$Period <- "inc"
ams_results_ls$`ams_jena_results-co2_2019-02-25`$Archived_Incubations_30.xlsx$Experiment <- "arc"

# ams_results_ls$`ams_jena_results-co2_2019-04-30`
# `Rost_31-2.xlsx`
# Experiment = arc
# Treatment = air-dry + storage
# Period = inc, pre (SEW11-2-2)
ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`$SampleName <- substr(ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`$Probe, 1, 9)
ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`$Treatment <- "air-dry + storage"
ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`$Experiment <- "arc"
ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`[2:9, "Period"] <- "inc"
ams_results_ls$`ams_jena_results-co2_2019-04-30`$`Rost_31-2.xlsx`[10, "Period"] <- "pre"

# ams_results_ls$`ams_jena_results-co2_2020-02-13`
# Rost_47.xlsx 
# Experiment = rewet
# Treatment = control
# Period = pre
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_47.xlsx$SampleName <- substr(ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_47.xlsx$Probe, 1, 7)
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_47.xlsx$Treatment <- "control"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_47.xlsx$Experiment <- "rewet"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_47.xlsx$Period <- "pre"
# Rost_50.xlsx
# Experiment = rewet
# Treatment = control
# Period = inc
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_50.xlsx$SampleName <- substr(ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_50.xlsx$Probe, 1, 7)
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_50.xlsx$Treatment <- "control"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_50.xlsx$Experiment <- "rewet"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_50.xlsx$Period <- "inc"
# Rost_52.xlsx
# Experiment = rewet
# Treatment = air-dry
# Period = pre, inc
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx$SampleName <- substr(ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx$Probe, 1, 11)
pre.ix <- which(grepl("PRE", ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx$Probe))
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx$Treatment <- "air-dry"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx$Experiment <- "rewet"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx[pre.ix, "Period"] <- "pre"
ams_results_ls$`ams_jena_results-co2_2020-02-13`$Rost_52.xlsx[-pre.ix, "Period"] <- "inc"
```

7. Combine data.
```{r combine 14C soil obs data}
# flatten list and remove AMS blanks, NA samples, and non-Exploratory data
ams_results_ls2 <- lapply(ams_results_ls[3:7], function(x) bind_rows(x))
ams_results_exp1_2.df <- bind_rows(lapply(ams_results_ls2, function(x) extra.clean.fx(x)))
# cut out non-relevant AMS results columns
nms.ams.vars <- c("F14C", "err", "∆14C.(‰)", "err.(‰)",
                 "SampleName", "Treatment", "Period", "Experiment")
ams_results_exp1_2.df <- ams_results_exp1_2.df[ , nms.ams.vars]
colnames(ams_results_exp1_2.df) <- c("fm", "fm_err", "d14c", "d14c_err", nms.ams.vars[5:8])

# merge with template
if(nrow(merge(all.14c.template, ams_results_exp1_2.df, all.x = TRUE)) == nrow(all.14c.template)) {
  all.14c <- merge(all.14c.template, ams_results_exp1_2.df, all.x = TRUE)
} else {
  cat("duplicate sample merge error")
}

# merge soil obs data with 14c data
if(nrow(merge(all.14c, ts.epsn.avg, by = c("SampleName", "Period"))) == nrow(all.14c)) {
  all.14c <- merge(all.14c, ts.epsn.avg, by = c("SampleName", "Period"))
} else {
  cat("duplicate sample merge error")
}

# add YearSampled column
all.14c$YearSampled <- ifelse(all.14c$Experiment == "arc", 2011, 2019)

# calculate fraction modern from d14C as needed
all.14c$fm <- ifelse(is.na(all.14c$fm), 
                     d14c.fm.fx(all.14c$YearSampled, all.14c$d14c),
                     all.14c$fm)

# correct 2011 treatment samples for decay
all.14c$d14c_corr <- decay.corr.fx(all.14c$YearSampled, all.14c$fm)

# sort (order) to look at data
all.14c <- all.14c[order(all.14c$Experiment, all.14c$Period, all.14c$Treatment), ]

# calculate mean, min, and max of numeric data, by plot (ID)
all.14c.sum <- select(all.14c, -SampleName) %>%
  group_by(ID, Type, Period, Treatment, Experiment, YearSampled) %>%
  summarise_all(list(mean = mean, max = max, min = min), na.rm = TRUE)

# remove NaN, Inf, and -Inf
all.14c.sum[which(!is.finite(all.14c.sum$d14c_corr_mean)), "d14c_corr_mean"] <- NA
all.14c.sum[which(!is.finite(all.14c.sum$d14c_corr_min)), "d14c_corr_min"] <- NA
all.14c.sum[which(!is.finite(all.14c.sum$d14c_corr_max)), "d14c_corr_max"] <- NA

# *** Need to figure out method for determining that these are outliers *** 
# # remove outliers
# all.14c <- all.14c[-which(all.14c$SampleName == "HEW26-1" | all.14c$SampleName == "HEW49-1"),]


# remove unnecessary objects
rm(ams_results_ls2, nms.ams.vars)
```

8. Count number of ^14^C observations for checking plots.
```{r counts for checking plots, include = FALSE}
# count !is.na(14C) cases by SampleName
all.14c[-which(is.na(all.14c$d14c_corr)),] %>%
  group_by(Experiment, Treatment, Period, Type) %>%
  count()
# by ID
all.14c[-which(is.na(all.14c$d14c_corr)),] %>%
  group_by(Experiment, Treatment, Period, Type) %>%
  distinct(ID) %>%
  count()
```

9. Plot pre-incubation period $\Delta$^14^C against equilibrium respiration period $\Delta$^14^C.
* Points are means of duplicate lab reps and error bars are min and max (except for the 2011 control samples, which were not replicated)
* Pre-incubation $\Delta$^14^C was not measured for the 2011 control samples.
* Relative outlier point is the very negative (mean = -51.1‰) HEW22 pre-incubation control samples from the 2019 air-dry experiment.
* Samples from three of the forest plots of the 2011 treatment samples failed to accumulate enough CO~2~ to measure ^14^C.
```{r pre vs inc 14c plot}
all.14c.pre.inc <- merge(all.14c.sum[all.14c.sum$Period == "pre", c("ID", "Experiment", "Type", "Treatment", "d14c_corr_mean", "d14c_corr_min", "d14c_corr_max")],
                         all.14c.sum[all.14c.sum$Period == "inc", c("ID", "Experiment", "Type", "Treatment", "d14c_corr_mean", "d14c_corr_min", "d14c_corr_max")],
                         by = c("ID", "Experiment", "Type", "Treatment"),
                         suffixes = c("_pre", "_inc"))
all.14c.pre.inc$treat.bi <- ifelse(all.14c.pre.inc$Treatment == "control", "control", "treatment")

all.14c.pre.inc %>%
  ggplot(., aes(d14c_corr_mean_pre, d14c_corr_mean_inc, color = Type, shape = Treatment)) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_vline(xintercept = 0, color = "gray") +
  geom_hline(yintercept = 0, color = "gray") +
  geom_point(size = 3) +
  geom_errorbar(
    aes(ymin = d14c_corr_min_inc, 
        ymax = d14c_corr_max_inc, 
        color = Type), 
    width = .25) +
  geom_errorbarh(
    aes(xmin = d14c_corr_min_pre, 
        xmax = d14c_corr_max_pre, 
        color = Type), 
    height = .9) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Treatment',
                     values = c("control" = 16,
                                "air-dry" = 1,
                                "air-dry + storage" = 0)) +
  scale_x_continuous(limits = c(-60, 115)) +
  scale_y_continuous(limits = c(-60, 115)) +
  xlab(expression('Pre-incubation '*Delta*''^14*'C (per mille)')) +
  ylab(expression('Equilibrium respiration '*Delta*''^14*'C (per mille)')) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.key.height=unit(.8, "cm"),
        aspect.ratio = 1)
```

10. Plot $\Delta$^14^C against proportion of soil C respired by experiment, land cover, and sampling period.
* Note that data are first shown averaged by plot (Fig. 1), and then averaged by land use and treatment within sampling periods (Fig. 2)
* Pre-incubation $\Delta$^14^C was not measured for the 2011 control samples.
* Outlier data excluded (HEW22 control pre-incubation)
```{r plot 14c by c resp}
# collapse treatment variable into binary control/treatment
all.14c.sum$treat.bi <- ifelse(all.14c.sum$Treatment == "control", "control","treatment")
# remove HEW22 control pre

all.14c.sum %>%
  mutate(ID.treat = paste(ID, Treatment)) %>%
  mutate(treat.Period = paste(treat.bi, Period)) %>%
  mutate(ID.treat.Period = paste(ID, treat.Period)) %>%
  filter(ID.treat.Period != "HEW22 control pre") %>%
  ggplot(., aes(mgCO2.C_gC_mean, d14c_corr_mean, color = Type, shape = treat.Period)) +
  geom_point(size = 3) +
  geom_path(aes(group = ID.treat)) +
  geom_errorbar(
    aes(ymin = d14c_corr_min, 
        ymax = d14c_corr_max, 
        color = Type), 
    width = .25) +
  geom_errorbarh(
    aes(xmin = mgCO2.C_gC_min, 
        xmax = mgCO2.C_gC_max, 
        color = Type), 
    height = .9) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Sampling period (treatment)',
                     values =c(16, 17, 1, 2),
                     labels = c("control pre" = 'pre-incubation\n(control)', 
                                "control inc" = 'equilibrium respiration\n(control)',
                                "treatment pre" = 'pre-incubation\n(air-dry/air-dry + storage)',
                                "treatment inc" = 'equilibrium respiration\n(air-dry/air-dry + storage)')) +
  facet_grid(cols = vars(Type), rows = vars(YearSampled)) +
  xlab(expression('Respired C (mgCO'[2]*'-C'*' g soil C'^-1*')')) +
  ylab(expression('mean '*Delta*''^14*'C (per mille)')) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.key.height=unit(.8, "cm"))

# average control and treatment data
# note that upper/lower limits = 2xSE
all.14c.sum2 <- mutate(all.14c, ID.per.exp.trt = paste(ID, Period, Experiment, Treatment)) %>%
  filter(ID.per.exp.trt != "HEW22 pre rewet control") %>%
  select(Type, Period, Treatment, Experiment, YearSampled, d14c_corr, mgCO2.C_gC) %>%
  group_by(Type, Period, Treatment, Experiment, YearSampled) %>%
  add_count() %>%
  summarize_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(d14c_corr_se = d14c_corr_sd/n_mean,
         d14c_corr_u = d14c_corr_mean + d14c_corr_se*2,
         d14c_corr_l = d14c_corr_mean - d14c_corr_se*2,
         mgCO2.C_gC_se = mgCO2.C_gC_sd/n_mean,
         mgCO2.C_gC_u = mgCO2.C_gC_mean + mgCO2.C_gC_se*2,
         mgCO2.C_gC_l = mgCO2.C_gC_mean - mgCO2.C_gC_se*2) 

all.14c.sum2$treat.bi <- ifelse(all.14c.sum2$Treatment == "control", "control","treatment")
all.14c.sum2 %>%
  mutate(treat.Period = paste(treat.bi, Period)) %>%
  ggplot(., aes(mgCO2.C_gC_mean, d14c_corr_mean, color = Type, shape = treat.Period)) +
  geom_point(size = 3) +
  geom_path(aes(group = Treatment)) +
  geom_errorbar(
    aes(ymin = d14c_corr_u, 
        ymax = d14c_corr_l, 
        color = Type), 
    width = .25) +
  geom_errorbarh(
    aes(xmin = mgCO2.C_gC_u, 
        xmax = mgCO2.C_gC_l, 
        color = Type), 
    height = .9) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Sampling period (treatment)',
                     values =c(16, 17, 1, 2),
                     labels = c("control pre" = 'pre-incubation\n(control)', 
                                "control inc" = 'equilibrium respiration\n(control)',
                                "treatment pre" = 'pre-incubation\n(air-dry/air-dry + storage)',
                                "treatment inc" = 'equilibrium respiration\n(air-dry/air-dry + storage)')) +
  facet_grid(cols = vars(Type), rows = vars(YearSampled)) +
  xlab(expression('Respired C (mgCO'[2]*'-C'*' g soil C'^-1*')')) +
  ylab(expression('mean '*Delta*''^14*'C (per mille)')) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.key.height=unit(.8, "cm"))
```

11. Same plot as in step 10, but including outlier data.
```{r plot 14c by c resp with outlier}
# average control and treatment data
all.14c.sum3 <- select(all.14c, Type, Period, Treatment, Experiment, YearSampled, d14c_corr, mgCO2.C_gC) %>%
  group_by(Type, Period, Treatment, Experiment, YearSampled) %>%
  add_count() %>%
  summarize_all(list(mean = mean, sd = sd), na.rm = TRUE) %>%
  mutate(d14c_corr_se = d14c_corr_sd/n_mean,
         d14c_corr_u = d14c_corr_mean + d14c_corr_se*2,
         d14c_corr_l = d14c_corr_mean - d14c_corr_se*2,
         mgCO2.C_gC_se = mgCO2.C_gC_sd/n_mean,
         mgCO2.C_gC_u = mgCO2.C_gC_mean + mgCO2.C_gC_se*2,
         mgCO2.C_gC_l = mgCO2.C_gC_mean - mgCO2.C_gC_se*2) 

all.14c.sum3$treat.bi <- ifelse(all.14c.sum3$Treatment == "control", "control","treatment")
all.14c.sum3 %>%
  mutate(treat.Period = paste(treat.bi, Period)) %>%
  ggplot(., aes(mgCO2.C_gC_mean, d14c_corr_mean, color = Type, shape = treat.Period)) +
  geom_point(size = 3) +
  geom_path(aes(group = Treatment)) +
  geom_errorbar(
    aes(ymin = d14c_corr_u, 
        ymax = d14c_corr_l, 
        color = Type), 
    width = .25) +
  geom_errorbarh(
    aes(xmin = mgCO2.C_gC_u, 
        xmax = mgCO2.C_gC_l, 
        color = Type), 
    height = .9) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Sampling period (treatment)',
                     values =c(16, 17, 1, 2),
                     labels = c("control pre" = 'pre-incubation\n(control)', 
                                "control inc" = 'equilibrium respiration\n(control)',
                                "treatment pre" = 'pre-incubation\n(air-dry/air-dry + storage)',
                                "treatment inc" = 'equilibrium respiration\n(air-dry/air-dry + storage)')) +
  facet_grid(cols = vars(Type), rows = vars(YearSampled)) +
  xlab(expression('Respired C (mgCO'[2]*'-C'*' g soil C'^-1*')')) +
  ylab(expression('mean '*Delta*''^14*'C (per mille)')) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.key.height=unit(.8, "cm"))
```

12. Show treatment effects on observed equilibrium period ^14^C.
* Fig. 1 shows treatment effects as means with inferential error bars (2x SE)
* Fig. 2 shows the direction of mean treatment effects over time in reference to the atmosphere (gray line)
```{r treatment effects by time}
# first load atmospheric data from ISRaD and bind future projection
Datm <- rbind(graven, future14C)
Datm <- Datm[Datm$Date > 1900, c("Date", "NHc14")]

# # code for plotting data by ID
# all.14c.sum %>%
#   filter(Period == "inc") %>%
#   filter(!grepl("S", ID)) %>%
#   mutate(year.ID = paste(YearSampled, ID)) %>%
#   ggplot(., aes(YearSampled, d14c_corr_mean, color = Type)) +
#   geom_point(aes(shape = Treatment), size = 3) +
#   geom_path(aes(group = year.ID), 
#             arrow = arrow(type = "open", length = unit(.1, "inches"), ends = "last"),
#             show.legend = FALSE) +
#   geom_path(data = Datm, aes(Date, NHc14), color = "darkgray") +
#   scale_color_manual(name = 'Land use',
#                      values =c('F'='#a35513','G'='#1361a3'),
#                      labels = c('Forest','Grassland')) +
#   scale_shape_manual(name = 'Treatment',
#                      values = c("air-dry" = 1, 
#                                 "air-dry + storage" = 0,
#                                 "control" = 16)) +
#   scale_x_continuous(limits = c(2010, 2020), breaks = c(2013, 2016, 2019)) +
#   scale_y_continuous(limits = c(-15, 100)) +
#   xlab('Year sampled') +
#   ylab(expression('mean '*Delta*''^14*'C (per mille)')) +
#   facet_wrap(~ ID, ncol = 3) +
#   theme_bw() +
#   theme(panel.grid = element_blank())

# plot as side-by-side means w/ 2xSE
# will change to 95%CIs at some point, but need to calculate test statistic with appropriate df
all.14c.sum2 %>%
  filter(Period == "inc") %>%
  ggplot(., aes(treat.bi, d14c_corr_mean, color = Type)) +
  geom_point(aes(shape = Treatment), size = 3) +
  geom_errorbar(
    aes(ymin = d14c_corr_u, 
        ymax = d14c_corr_l, 
        color = Type), 
    width = .1) +
  scale_color_manual(name = 'Land use',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Treatment',
                     values = c("air-dry" = 1, 
                                "air-dry + storage" = 0,
                                "control" = 16)) +
  ylab(expression('mean '*Delta*''^14*'C (per mille)')) +
  facet_grid(cols = vars(Type), rows = vars(YearSampled)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank())

# plot over time, averaged by Type
all.14c.sum2 %>%
  filter(Period == "inc") %>%
  mutate(year.Type = paste(YearSampled, Type)) %>%
  ggplot(., aes(YearSampled, d14c_corr_mean, color = Type)) +
  geom_point(aes(shape = Treatment), size = 3) +
  geom_path(aes(group = year.Type), 
            arrow = arrow(type = "open", length = unit(.1, "inches"), ends = "last"),
            show.legend = FALSE) +
  geom_path(data = Datm, aes(Date, NHc14), color = "darkgray") +
  scale_color_manual(name = 'Land use',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_shape_manual(name = 'Treatment',
                     values = c("air-dry" = 1, 
                                "air-dry + storage" = 0,
                                "control" = 16)) +
  scale_x_continuous(limits = c(2010, 2020), breaks = c(2013, 2016, 2019)) +
  scale_y_continuous(limits = c(-15, 100)) +
  xlab('Year sampled') +
  ylab(expression('mean '*Delta*''^14*'C (per mille)')) +
  facet_grid(cols = vars(Type)) +
  theme_bw() +
  theme(panel.grid = element_blank())
```

13. Create template for external ^14^C data from the second part of the air-dry + storage experiment, i.e. samples for which the control incubations were not performed at MPI-BGC.
```{r external template}

```


14. Show the effect of storage duration by plotting the difference between control and treatment 14C as a function of time archived.
```{r storage duration}

```

