---
title: "Archived Soil Incubations Project"
author: "J. Beem-Miller"
date: "21 Apr 2020"
output:
  html_notebook: default
  html_document:
    df_print: paged
  pdf_document:
    latex_engine: xelatex
---
```{r setup, include = FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(SoilR)
library(corrplot)
```
# Notes:
* This workbook is intended to load and prepare the key data for analysis for the archive incubation project.
* in general, this is an updated version of script "./src/arc_inc_master.R"
* all code chunk options are set to "echo = FALSE"; see raw .Rmd file for data wrangling code.

# CO~2~ fluxes and soil data 
1. Load flux data from air-dry + storage control samples, and convert from "wide" to "long" format so as to match other data.
```{r read wide ts data, echo = FALSE}
# Read air-dry + storage respiration control data
archive.ctl.ts.wide <- read.csv("../data/derived/arc-storage-t1-flux/arc-inc_xplr_arc-storage-t1-flux_2020-04-20.csv")

# Convert time data from wide to long
archive.ctl.ts.d <- select(archive.ctl.ts.wide, starts_with("inc_time_d")) %>%
  pivot_longer(everything(),
               names_to = "timepoint_cmtv",
               names_prefix = "inc_time_d_",
               values_to = "time_d")
# sort by timepoint_cmtv
archive.ctl.ts.d <- data.frame(archive.ctl.ts.d[order(archive.ctl.ts.d$timepoint_cmtv),])

# Convert mgCO2 data from wide to long
archive.ctl.ts.co2 <- select(archive.ctl.ts.wide, starts_with("inc_mgCO2_jar_")) %>%
  pivot_longer(everything(),
               names_to = "timepoint_cmtv",
               names_prefix = "inc_mgCO2_jar_",
               values_to = "mgCO2_jar")
# sort by timepoint_cmtv
archive.ctl.ts.co2 <- archive.ctl.ts.co2[order(archive.ctl.ts.co2$timepoint_cmtv),]

# assemble in long dataframe 
archive.ctl.ts <- data.frame(ID = rep(unique(archive.ctl.ts.wide$ID), 4),
                             Period = "inc",
                             timepoint_cmtv = rep(seq(from = 2, 
                                                      to = 5), 
                                                  each = length(archive.ctl.ts.wide$ID)),
                             time_d = archive.ctl.ts.d$time_d,
                             mgCO2_jar = archive.ctl.ts.co2$mgCO2_jar)

# add preincubation data
archive.ctl.ts.pre <- archive.ctl.ts.wide[1:length(unique(archive.ctl.ts.wide$ID)),
                                          c("ID", "preinc_time_d", "preinc_mgCO2_jar")]
archive.ctl.ts.pre <- rename(archive.ctl.ts.pre, time_d = preinc_time_d, mgCO2_jar = preinc_mgCO2_jar)
archive.ctl.ts.pre$timepoint_cmtv <- 1
archive.ctl.ts.pre$Period <- "pre"
archive.ctl.ts.pre$time_d_cmtv <- archive.ctl.ts.pre$time_d
  
# Calculate time_d_cmtv
archive.ctl.ts <- bind_rows(
  lapply(
    split(archive.ctl.ts, archive.ctl.ts$timepoint_cmtv),
    function(x) {
      x$time_d_cmtv <- x$time_d + 
        archive.ctl.ts.pre[match(x$ID, archive.ctl.ts.pre$ID), "time_d"]
      return(x)
    }
    )
  )

# rbind preinc and inc data
archive.ctl.ts <- rbind(archive.ctl.ts.pre, archive.ctl.ts)

# add SampleName column
archive.ctl.ts$SampleName <- archive.ctl.ts$ID

# remove intermediate files
rm(archive.ctl.ts.d, archive.ctl.ts.co2, archive.ctl.ts.pre)
```

2. Load flux data from air-dry + storage samples and from air-dry experiment (ctl & treatment), C & N data for all the Exploratories samples (measured in 2011), and soil mass and moisture data for all experiments.
```{r read long ts data, echo = FALSE}
# Read Xplr C and N data
xplr.cn <- read.csv("../data/external/exploratories_ischoening_soilcn_2011/170407_CN_concentrations_Exploratories_EP_Plots_2011.csv")

# Read soil mass and moisture info for air-dry + storage data
jarinfo.arc <- read.csv("../data/derived/arc-storage-t2-jarInfo/jar_information.csv")

# Read soil mass and moisture info for air-dry data
jarinfo.rewet <- read.csv("../data/derived/air-dry-2019-whc/air-dry-2019-whc_2020-04-21.csv")

# Read air-dry + storage respiration data
archive.arc.ts <- read.csv("../data/derived/arc-storage-t2-flux/archive-flux-t2_2020-04-24.csv")

# Read control respiration data from 2019 air-dry experiment
rewet.ctl.ts <- read.csv("../data/derived/fresh-2019-flux/fresh-2019-flux_2020-04-24.csv")

# Read treatment respiration data from 2019 air-dry experiment
rewet.dry.ts <- read.csv("../data/derived/dried-2019-flux/dried-2019-flux_2020-04-24.csv")
```

3. Combine and summarize data in long format to calculate respiration rates and plot over time.
```{r summarize data, echo = FALSE, include = FALSE}
# NB: set "include" to false to suppress bind_rows warning about coercing factor to char
# remove formula_check columns
invisible(list2env(lapply(list(archive.arc.ts = archive.arc.ts, 
                               rewet.ctl.ts = rewet.ctl.ts, 
                               rewet.dry.ts = rewet.dry.ts
                               ),
                          function(x) {
                            x$formula_check <- NULL
                            return(x)
                            }),
                   envir = .GlobalEnv)
          )

# Add Treatment columns to each dataset
archive.arc.ts$Treatment <- "air-dry + storage (2011)"
archive.ctl.ts$Treatment <- "control (2011)"
rewet.ctl.ts$Treatment <- "control (2019)"
rewet.dry.ts$Treatment <- "air-dry (2019)"

# combine rewet data
rewet.ts <- rbind(rewet.ctl.ts, rewet.dry.ts)
rewet.ts$Experiment <- "2019"

# add soil dry wt data
archive.arc.ts$dw_g <- jarinfo.arc[match(archive.arc.ts$SampleName, jarinfo.arc$Sample), "Soil.dry.weight_.g."]
archive.ctl.ts$dw_g <- archive.ctl.ts.wide[match(archive.ctl.ts$ID, archive.ctl.ts.wide$ID), "dry_soil_wt_corrected_g"]
rewet.ts <- merge(rewet.ts, jarinfo.rewet[ , c("ID", "Treatment", "dw_g")], by = c("ID", "Treatment"))

# combine archive data
archive.ts <- rbind(archive.ctl.ts, 
                    archive.arc.ts[ , names(archive.ctl.ts)])
archive.ts$Experiment <- "2011"

# Test that required names are present
nms <- c("SampleName", "ID", "Experiment", "Treatment", "Period", "timepoint_cmtv",  "time_d", "time_d_cmtv", "mgCO2_jar", "dw_g")
invisible(lapply(list(archive.ts = archive.ts,
                      rewet.ts = rewet.ts),
       function(x) {
         ifelse(!is.na(match(nms, names(x))), "yes", "no")
       }
       ))

# combine all data
ts <- bind_rows(archive.ts[ , nms], rewet.ts[ , nms])

# add C content and Type column
ts$gC_gS <- xplr.cn[match(ts$ID, xplr.cn$EP_Plotid), "Total_C"]*10^-3
ts$Type <- ifelse(grepl("G", ts$ID), "G", "F")

# calculate CO2 respiration in mgCO2-C per g soil C
# NB: 12/44 = mass ratio of C in CO2
ts$mgCO2.C_gC <- (ts$mgCO2_jar*(12/44))/(ts$dw_g*ts$gC_gS)
ts$mgCO2.C_gC_d <- ts$mgCO2.C_gC/ts$time_d

# summarize CO2 release data for each timepoint, by experiment, treatment, and type
# for some reason n() doesn't work when included with the summarize_all syntax, so done separately
ts.avg <- merge(
  na.omit(ts) %>%
  select(Experiment, Treatment, Type, timepoint_cmtv, mgCO2.C_gC_d, time_d_cmtv)  %>%
  group_by(Experiment, Treatment, Type, timepoint_cmtv) %>%
  summarise_all(list(mean = mean, sd = sd), na.rm = TRUE),
  na.omit(ts) %>%
  select(Experiment, Treatment, Type, timepoint_cmtv, mgCO2.C_gC_d, time_d_cmtv)  %>%
  group_by(Experiment, Treatment, Type, timepoint_cmtv) %>%
  summarize(n = n()),
  by = c("Experiment", "Treatment", "Type", "timepoint_cmtv")
  )
ts.avg$se_slope <- ts.avg$mgCO2.C_gC_d_sd/sqrt(ts.avg$n)
ts.avg$se_slope_l <- ts.avg$mgCO2.C_gC_d_mean - ts.avg$se_slope
ts.avg$se_slope_u <- ts.avg$mgCO2.C_gC_d_mean + ts.avg$se_slope

# add timepoint zero data
tp0.f <- function(df) {
  tp0 <- df[1, ]
  tp0[ , -which(names(tp0) == "Experiment" | names(tp0) == "Treatment" | names(tp0) == "Type" | names(tp0) == "n")] <- 0
  rbind(tp0, df)
}
ts.avg <- lapply(split(ts.avg, ts.avg$Treatment), function(x) {
  lapply(split(x, x$Type), tp0.f)
  })
ts.avg <- bind_rows(lapply(ts.avg, bind_rows))

# restore classes
ts.avg <- as.data.frame(lapply(ts.avg, type.convert))
```

4. Plot of CO~2~ fluxes over time. Note that the final measurement points for a few samples which took >18 days to reach CO~2~ targets are excluded for display reasons. Respiration rates for those samples remained flat.
```{r CO2 fluxes plots, echo = FALSE}
ggplot(ts.avg, aes(time_d_cmtv_mean, mgCO2.C_gC_d_mean)) +
  geom_vline(xintercept = 4, color="gray") +
  geom_ribbon(aes(ymin = se_slope_l, ymax = se_slope_u, fill = Type, linetype = Treatment, alpha = Treatment)) +
  geom_line(aes(color = Type, linetype = Treatment)) +
  facet_grid(rows = vars(Experiment)) +
  scale_x_continuous(limits = c(0,18)) +
  # scale_y_continuous(limits = c(0,30)) +
  scale_color_manual(name = 'Landuse',
                     values =c('F'='#a35513','G'='#1361a3'),
                     labels = c('Forest','Grassland')) +
  scale_fill_manual(name = 'Std. Err.',
                    values =c('F'='#a35513','G'='#1361a3'),
                    labels = c('Forest','Grassland')) +
  scale_alpha_manual(name = 'Treatment',
                     values = c("air-dry + storage (2011)" = .2, 
                                "control (2011)" = .4,
                                "air-dry (2019)" = .2,
                                "control (2019)" = .4)) +
  scale_linetype_manual(name = 'Treatment',
                        values = c("air-dry + storage (2011)" = 'dashed', 
                                   "control (2011)" ='solid',
                                   "air-dry (2019)" = "dashed",
                                   "control (2019)" = "solid")) +
  ylab(expression('Respiration Rate (mgCO'[2]*'-C gC'^-1*'d'^-1*')')) +
  xlab("Time (days)") +
  theme_bw() +
  theme(panel.grid = element_blank())
```

# Isotope data

*section in progress*

1. Read in isotope data from various sources. First load helper function 'read_jena_ams_results.R"
```{r load ams-jena-ingest fx, echo = FALSE}
source("./utilities/jena_ams_ingest.R")
```

Next read in data from the appropriate directories in 'data/raw'.
```{r read iso data, echo = FALSE}
# identify subdirectories in 'raw' directory with "ams_jena" in name
ams_jena_results_dirs <- list.files("../data/raw", pattern = "ams_jena_results", full.names = TRUE)
ams_results_ls <- lapply(seq_along(ams_jena_results_dirs), function(i) {
  read_jena_ams_results(ams_jena_results_dirs[i])
})
names(ams_results_ls) <- list.files("../data/raw", pattern = "ams_jena_results")
```

2. Create a "tidy" style template for the data, i.e. variables in columns. 
* Key variables are as follows:
  * SampleName (incorporates lab rep and treatment, e.g. "HEG10-1_dry")
  * ID (plot IDs, e.g. for "HEG10" for Exploratory samples)
  * Treatment (3 treatments: air-dry, air-dry + storage, storage duration; + controls)
  * Type (2 levels: F = forest, G = grassland)
  * Period (incubation period, 2 levels: pre = preincubation, inc = equilibrium incubation)
  * Experiment (3 levels: arc = air-dry + storage, rewet = air-dry/rewet, time = storage duration)

* Observational columns include:
  * \Delta14C-CO2
  * \delta13C-CO2
  * C_g_kg (C content)
  * dw_g (dry weight)
  * mgCO2.C_gS (mgCO2-C respired per g soil per period)
  * time_d (days in incubation period prior to measurement)
  * h2o_grav (gravimetric water content, pct)
  * h2o_whc_field (percent of water holding capacity, field-moist)
  
```{r non-timeseries data template, echo = FALSE}
unique.id.n <- c(length(unique(archive.ctl.ts$ID)),
                 length(unique(archive.arc.ts$SampleName)),
                 length(unique(rewet.ctl.ts$SampleName)),
                 length(unique(rewet.dry.ts$SampleName)))
pre.14c <- data.frame(SampleName = c(as.character(unique(archive.ctl.ts$ID)),
                                     as.character(unique(archive.arc.ts$SampleName)),
                                     as.character(unique(rewet.ctl.ts$SampleName)),
                                     as.character(unique(rewet.dry.ts$SampleName))))
pre.14c$ID <- substr(pre.14c$SampleName, 1, 5)
pre.14c$Type <- ifelse(grepl("G", pre.14c$ID), "G", "F")
pre.14c$Experiment <- c(rep("arc", unique.id.n[1] + unique.id.n[2]),
                       rep("rewet", unique.id.n[3] + unique.id.n[4]))
pre.14c$Treatment <- c(rep("control", unique.id.n[1]),
                       rep("air-dry + storage", unique.id.n[2]),
                       rep("control", unique.id.n[3]),
                       rep("air-dry", unique.id.n[4]))
pre.14c$Period <- "pre"

# create inc period df as duplicate of pre-inc df, but test that it is the right shape first
if(nrow(pre.14c) == sum(unique.id.n)) {
  inc.14c <- pre.14c
} else {
  "pre.14c data frame malformed"
}
```
3. Add observational data from timeseries data.

```{r combine soil obs data, echo = FALSE}
# summarize time and co2 data by experiment, period, and sample name
ts.epsn.avg <- na.omit(ts) %>%
  select(Period, SampleName, gC_gS, dw_g, mgCO2.C_gC, time_d, time_d_cmtv)  %>%
  group_by(Period, SampleName) %>%
  summarise_all(list(max = max))


```


4. Add ^14^C data to template.

```{r combine 14C data, echo = FALSE}


```

